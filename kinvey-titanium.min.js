// Wrap dependencies in an IIFE so they are exported onto the root object only.
(function(define, module) {
  var window = this;
  var setTimeout = function(fn) {
    return window.setTimeout(fn, 0);
  };
  var exports = window.__KinveySocialAdapter = window;
  var File = function() { };
;
/**@license MIT-promiscuous-Â©Ruben Verborgh*/
!function(n,t){function c(n,t){return(typeof t)[0]==n}function u(o,e){return e=function f(i,h,l,a,p,s){function y(n){return function(t){p&&(p=0,f(c,n,t))}}if(a=f.q,i!=c)return u(function(n,t){a.push({p:this,r:n,j:t,1:i,0:h})});if(l&&c(n,l)|c(t,l))try{p=l.then}catch(j){h=0,l=j}if(c(n,p))try{p.call(l,y(1),h=y(0))}catch(j){h(j)}else for(e=function(t,e){return c(n,t=h?t:e)?u(function(n,c){r(this,n,c,l,t)}):o},s=0;s<a.length;)p=a[s++],c(n,i=p[h])?r(p.p,p.r,p.j,l,i):(h?p.r:p.j)(l)},e.q=[],o.call(o={then:function(n,t){return e(n,t)},"catch":function(n){return e(0,n)}},function(n){e(c,1,n)},function(n){e(c,0,n)}),o}function r(u,r,o,e,f){setTimeout(function(){try{e=f(e),f=e&&c(t,e)|c(n,e)&&e.then,c(n,f)?e==u?o(TypeError()):f.call(e,r,o):r(e)}catch(i){o(i)}})}function o(n){return u(function(t){t(n)})}Promise=u,u.resolve=o,u.reject=function(n){return u(function(t,c){c(n)})},u.all=function(n){return u(function(t,c,u,r){r=[],u=n.length||t(r),n.map(function(n,e){o(n).then(function(n){r[e]=n,--u||t(r)},c)})})}}("f","o");;
(function(){var m=new function(){function g(a){return a?0:-1}var e=this.priority=function(a,b){for(var c=a.exprs,f=0,d=0,e=c.length;d<e;d++){var h=c[d];if(!~(h=h.e(h.v,b instanceof Date?b.getTime():b,b)))return-1;f+=h}return f},d=this.parse=function(a,b){a||(a={$eq:a});var c=[];if(a.constructor==Object)for(var f in a){var g=l[f]?f:"$trav",k=a[f],h=k;if(j[g]){if(~f.indexOf(".")){h=f.split(".");f=h.shift();for(var n={},m=n,p=0,s=h.length-1;p<s;p++)m=m[h[p]]={};m[h[p]]=k;h=k=n}if(k instanceof Array){h=
[];for(n=k.length;n--;)h.push(d(k[n]))}else h=d(k,f)}c.push(r(g,f,h))}else c.push(r("$eq",f,a));var q={exprs:c,k:b,test:function(a){return!!~q.priority(a)},priority:function(a){return e(q,a)}};return q},j=this.traversable={$and:!0,$or:!0,$nor:!0,$trav:!0,$not:!0},l=this.testers={$eq:function(a,b){return g(a.test(b))},$ne:function(a,b){return g(!a.test(b))},$lt:function(a,b){return a>b?0:-1},$gt:function(a,b){return a<b?0:-1},$lte:function(a,b){return a>=b?0:-1},$gte:function(a,b){return a<=b?0:-1},
$exists:function(a,b){return a===(null!=b)?0:-1},$in:function(a,b){if(b instanceof Array)for(var c=b.length;c--;){if(~a.indexOf(b[c]))return c}else return g(~a.indexOf(b));return-1},$not:function(a,b){if(!a.test)throw Error("$not test should include an expression, not a value. Use $ne instead.");return g(!a.test(b))},$type:function(a,b,c){return c?c instanceof a||c.constructor==a?0:-1:-1},$nin:function(a,b){return~l.$in(a,b)?-1:0},$mod:function(a,b){return b%a[0]==a[1]?0:-1},$all:function(a,b){for(var c=
a.length;c--;)if(!~b.indexOf(a[c]))return-1;return 0},$size:function(a,b){return b?a==b.length?0:-1:-1},$or:function(a,b){for(var c=a.length,f=c;c--;)if(~e(a[c],b))return c;return 0==f?0:-1},$nor:function(a,b){for(var c=a.length;c--;)if(~e(a[c],b))return-1;return 0},$and:function(a,b){for(var c=a.length;c--;)if(!~e(a[c],b))return-1;return 0},$trav:function(a,b){if(b instanceof Array){for(var c=b.length;c--;){var f=b[c];if(f[a.k]&&~e(a,f[a.k]))return c}return-1}return e(a,b?b[a.k]:void 0)},$regex:function(a,
b){return RegExp(a).test(b)?0:-1}},k={$eq:function(a){return a instanceof RegExp?a:{test:a instanceof Function?a:function(b){return b instanceof Array?~b.indexOf(a):a==b}}},$ne:function(a){return k.$eq(a)}},r=function(a,b,c){c=c instanceof Date?c.getTime():c;return{k:b,v:k[a]?k[a](c):c,e:l[a]}}},j=function(g,e,d){"object"!=typeof e&&(d=e,e=void 0);if(d){if("function"!=typeof d)throw Error("Unknown sift selector "+d);}else d=function(d){return d};var j=d,l=m.parse(g);d=function(d){for(var e=[],a,b,
c,f=0,g=d.length;f<g;f++)b=d[f],a=j(b),~(c=l.priority(a))&&e.push({value:b,priority:c});e.sort(function(a,b){return a.priority>b.priority?-1:1});d=Array(e.length);for(f=e.length;f--;)d[f]=e[f].value;return d};d.test=l.test;d.score=l.priority;d.query=g;return e?d(e):d};j.use=function(g){g.operators&&j.useOperators(g.operators)};j.useOperators=function(g){for(var e in g)j.useOperator(e,g[e])};j.useOperator=function(g,e){var d={},d="object"==typeof e?e:{test:e},j="$"+g;m.testers[j]=d.test;if(d.traversable||
d.traverse)m.traversable[j]=!0};"undefined"!=typeof module&&"undefined"!=typeof module.exports?module.exports=j:"undefined"!=typeof window&&(window.sift=j)})();
;
var exports=exports||this;exports.OAuth=function(a){function b(a){var e,b=arguments,c=b.callee,f=(b.length,this);if(!(this instanceof c))return new c(a);for(e in a)a.hasOwnProperty(e)&&(f[e]=a[e]);return f}function c(){}function d(a){var d,f,g,h,i,j,k,b=arguments,c=b.callee,l=/^([^:\/?#]+?:\/\/)*([^\/:?#]*)?(:[^\/?#]*)*([^?#]*)(\?[^#]*)?(#(.*))*/,m=this;return this instanceof c?(m.scheme="",m.host="",m.port="",m.path="",m.query=new e,m.anchor="",null!==a&&(d=a.match(l),f=d[1],g=d[2],h=d[3],i=d[4],j=d[5],k=d[6],f=void 0!==f?f.replace("://","").toLowerCase():"http",h=h?h.replace(":",""):"https"===f?"443":"80",f="http"==f&&"443"===h?"https":f,j=j?j.replace("?",""):"",k=k?k.replace("#",""):"",("https"===f&&"443"!==h||"http"===f&&"80"!==h)&&(g=g+":"+h),m.scheme=f,m.host=g,m.port=h,m.path=i||"/",m.query.setQueryParams(j),m.anchor=k||""),void 0):new c(a)}function e(a){var e,b=arguments,c=b.callee,f=(b.length,this);if(g.urlDecode,!(this instanceof c))return new c(a);if(void 0!=a)for(e in a)a.hasOwnProperty(e)&&(f[e]=a[e]);return f}function g(a){return this instanceof g?this.init(a):new g(a)}function h(a){var c,d,b=[];for(c in a)a[c]&&void 0!==a[c]&&""!==a[c]&&("realm"===c?d=c+'="'+a[c]+'"':b.push(c+'="'+g.urlEncode(a[c]+"")+'"'));return b.sort(),d&&b.unshift(d),b.join(", ")}function i(a,b,c,d){var f,e=[],h=g.urlEncode;for(f in c)void 0!==c[f]&&""!==c[f]&&e.push([g.urlEncode(f),g.urlEncode(c[f]+"")]);for(f in d)void 0!==d[f]&&""!==d[f]&&(c[f]||e.push([h(f),h(d[f]+"")]));return e=e.sort(function(a,b){return a[0]<b[0]?-1:a[0]>b[0]?1:a[1]<b[1]?-1:a[1]>b[1]?1:0}).map(function(a){return a.join("=")}),[a,h(b),h(e.join("&"))].join("&")}function j(){return parseInt(+new Date/1e3,10)}function k(a){function b(){return Math.floor(Math.random()*h.length)}a=a||64;var g,c=a/8,d="",e=c/4,f=c%4,h=["20","21","22","23","24","25","26","27","28","29","2A","2B","2C","2D","2E","2F","30","31","32","33","34","35","36","37","38","39","3A","3B","3C","3D","3E","3F","40","41","42","43","44","45","46","47","48","49","4A","4B","4C","4D","4E","4F","50","51","52","53","54","55","56","57","58","59","5A","5B","5C","5D","5E","5F","60","61","62","63","64","65","66","67","68","69","6A","6B","6C","6D","6E","6F","70","71","72","73","74","75","76","77","78","79","7A","7B","7C","7D","7E"];for(g=0;e>g;g++)d+=h[b()]+h[b()]+h[b()]+h[b()];for(g=0;f>g;g++)d+=h[b()];return d}function l(){var b;if("undefined"!=typeof a.Titanium&&"undefined"!=typeof a.Titanium.Network.createHTTPClient)b=a.Titanium.Network.createHTTPClient();else if("undefined"!=typeof require)try{b=new require("xhr").XMLHttpRequest()}catch(c){if("undefined"==typeof a.XMLHttpRequest)throw"No valid request transport found.";b=new a.XMLHttpRequest}else{if("undefined"==typeof a.XMLHttpRequest)throw"No valid request transport found.";b=new a.XMLHttpRequest}return b}function m(a){var b=new Array(++a);return b.join(0).split("")}function n(a){var c,d,b=[];for(d=0;d<a.length;d++)c=a.charCodeAt(d),128>c?b.push(c):2048>c?b.push(192+(c>>6),128+(63&c)):65536>c?b.push(224+(c>>12),128+(63&c>>6),128+(63&c)):2097152>c&&b.push(240+(c>>18),128+(63&c>>12),128+(63&c>>6),128+(63&c));return b}function o(a){var c,b=[];for(c=0;c<32*a.length;c+=8)b.push(255&a[c>>>5]>>>24-c%32);return b}function p(a){var d,b=[],c=a.length;for(d=0;c>d;d++)b.push((a[d]>>>4).toString(16)),b.push((15&a[d]).toString(16));return b.join("")}function q(a){var d,b="",c=a.length;for(d=0;c>d;d++)b+=String.fromCharCode(a[d]);return b}function r(a,b){return a<<b|a>>>32-b}function s(a){if(void 0!==a){var c,d,b=a;return b.constructor===String&&(b=n(b)),c=this instanceof s?this:new s(a),d=c.hash(b),p(d)}return this instanceof s?this:new s}function t(a,b,c,d){var h,i,j,k,e=n(b),f=n(c),g=e.length;for(g>a.blocksize&&(e=a.hash(e),g=e.length),e=e.concat(m(a.blocksize-g)),i=e.slice(0),j=e.slice(0),k=0;k<a.blocksize;k++)i[k]^=92,j[k]^=54;return h=a.hash(i.concat(a.hash(j.concat(f)))),d?p(h):q(h)}c.prototype={join:function(a){return a=a||"",this.values().join(a)},keys:function(){var a,b=[],c=this;for(a in c)c.hasOwnProperty(a)&&b.push(a);return b},values:function(){var a,b=[],c=this;for(a in c)c.hasOwnProperty(a)&&b.push(c[a]);return b},shift:function(){throw"not implimented"},unshift:function(){throw"not implimented"},push:function(){throw"not implimented"},pop:function(){throw"not implimented"},sort:function(){throw"not implimented"},ksort:function(a){var d,e,f,b=this,c=b.keys();for(void 0==a?c.sort():c.sort(a),d=0;d<c.length;d++)f=c[d],e=b[f],delete b[f],b[f]=e;return b},toObject:function(){var b,a={},c=this;for(b in c)c.hasOwnProperty(b)&&(a[b]=c[b]);return a}},b.prototype=new c,d.prototype={scheme:"",host:"",port:"",path:"",query:"",anchor:"",toString:function(){var a=this,b=a.query+"";return a.scheme+"://"+a.host+a.path+(""!=b?"?"+b:"")+(""!==a.anchor?"#"+a.anchor:"")}},e.prototype=new b,e.prototype.toString=function(){var a,b=this,c=[],d="",e="",f=g.urlEncode;b.ksort();for(a in b)b.hasOwnProperty(a)&&void 0!=a&&void 0!=b[a]&&(e=f(a)+"="+f(b[a]),c.push(e));return c.length>0&&(d=c.join("&")),d},e.prototype.setQueryParams=function(a){var d,e,f,i,b=arguments,c=b.length,h=this,j=g.urlDecode;if(1==c){if("object"==typeof a)for(d in a)a.hasOwnProperty(d)&&(h[d]=j(a[d]));else if("string"==typeof a)for(e=a.split("&"),d=0,f=e.length;f>d;d++)i=e[d].split("="),""!=i[0]&&(h[i[0]]=j(i[1]))}else for(d=0;c>d;d+=2)h[b[d]]=j(b[d+1])};var f="1.0";return g.prototype={realm:"",requestTokenUrl:"",authorizationUrl:"",accessTokenUrl:"",init:function(a){var b="",c={enablePrivilege:a.enablePrivilege||!1,proxyUrl:a.proxyUrl,callbackUrl:a.callbackUrl||"oob",consumerKey:a.consumerKey,consumerSecret:a.consumerSecret,accessTokenKey:a.accessTokenKey||b,accessTokenSecret:a.accessTokenSecret||b,verifier:b,signatureMethod:a.signatureMethod||"HMAC-SHA1"};return this.realm=a.realm||b,this.requestTokenUrl=a.requestTokenUrl||b,this.authorizationUrl=a.authorizationUrl||b,this.accessTokenUrl=a.accessTokenUrl||b,this.getAccessToken=function(){return[c.accessTokenKey,c.accessTokenSecret]},this.getAccessTokenKey=function(){return c.accessTokenKey},this.getAccessTokenSecret=function(){return c.accessTokenSecret},this.setAccessToken=function(a,b){b&&(a=[a,b]),c.accessTokenKey=a[0],c.accessTokenSecret=a[1]},this.getVerifier=function(){return c.verifier},this.setVerifier=function(a){c.verifier=a},this.setCallbackUrl=function(a){c.callbackUrl=a},this.request=function(a){var b,e,m,n,o,p,q,r,s,t,u,v,x,z,A,B,w=[],y={};b=a.method||"GET",e=d(a.url),m=a.data||{},n=a.headers||{},o=a.success||function(){},p=a.failure||function(){},A=function(){var a=!1;for(var b in m)(m[b]instanceof File||"undefined"!=typeof m[b].fileName)&&(a=!0);return a}(),x=a.appendQueryString?a.appendQueryString:!1,c.enablePrivilege&&netscape.security.PrivilegeManager.enablePrivilege("UniversalBrowserRead UniversalBrowserWrite"),q=l(),q.onreadystatechange=function(){if(4===q.readyState){var e,a=/^(.*?):\s*(.*?)\r?$/gm,b=n,c={},d="";if(q.getAllResponseHeaders)for(d=q.getAllResponseHeaders();e=a.exec(d);)c[e[1]]=e[2];else if(q.getResponseHeaders){d=q.getResponseHeaders();for(var f=0,g=d.length;g>f;++f)c[d[f][0]]=d[f][1]}var h=!1;"Content-Type"in c&&"text/xml"==c["Content-Type"]&&(h=!0);var i={text:q.responseText,xml:h?q.responseXML:"",requestHeaders:b,responseHeaders:c};q.status>=200&&q.status<=226||304==q.status||0===q.status?o(i):q.status>=400&&0!==q.status&&p(i)}},s={oauth_callback:c.callbackUrl,oauth_consumer_key:c.consumerKey,oauth_token:c.accessTokenKey,oauth_signature_method:c.signatureMethod,oauth_timestamp:j(),oauth_nonce:k(),oauth_verifier:c.verifier,oauth_version:f},t=c.signatureMethod,z=e.query.toObject();for(r in z)y[r]=z[r];if(!("Content-Type"in n&&"application/x-www-form-urlencoded"!=n["Content-Type"]||A))for(r in m)y[r]=m[r];if(B=e.scheme+"://"+e.host+e.path,u=i(b,B,s,y),v=g.signatureMethod[t](c.consumerSecret,c.accessTokenSecret,u),s.oauth_signature=v,this.realm&&(s.realm=this.realm),c.proxyUrl&&(e=d(c.proxyUrl+e.path)),x||"GET"==b)e.query.setQueryParams(m),w=null;else if(A){if(A){w=new FormData;for(r in m)w.append(r,m[r])}}else if("string"==typeof m)w=m,"Content-Type"in n||(n["Content-Type"]="text/plain");else{for(r in m)w.push(g.urlEncode(r)+"="+g.urlEncode(m[r]+""));w=w.sort().join("&"),"Content-Type"in n||(n["Content-Type"]="application/x-www-form-urlencoded")}q.open(b,e+"",!0),q.setRequestHeader("Authorization","OAuth "+h(s)),q.setRequestHeader("X-Requested-With","XMLHttpRequest");for(r in n)q.setRequestHeader(r,n[r]);q.send(w)},this},get:function(a,b,c){this.request({url:a,success:b,failure:c})},post:function(a,b,c,d){this.request({method:"POST",url:a,data:b,success:c,failure:d})},getJSON:function(a,b,c){this.get(a,function(a){b(JSON.parse(a.text))},c)},postJSON:function(a,b,c,d){this.request({method:"POST",url:a,data:JSON.stringify(b),success:function(a){c(JSON.parse(a.text))},failure:d,headers:{"Content-Type":"application/json"}})},parseTokenRequest:function(a,b){switch(b){case"text/xml":var c=a.xml.getElementsByTagName("token"),d=a.xml.getElementsByTagName("secret");i[g.urlDecode(c[0])]=g.urlDecode(d[0]);break;default:for(var e=0,f=a.text.split("&"),h=f.length,i={};h>e;++e){var j=f[e].split("=");i[g.urlDecode(j[0])]=g.urlDecode(j[1])}}return i},fetchRequestToken:function(a,b){var c=this;c.setAccessToken("","");var d=c.authorizationUrl;this.get(this.requestTokenUrl,function(b){var e=c.parseTokenRequest(b,b.responseHeaders["Content-Type"]||void 0);c.setAccessToken([e.oauth_token,e.oauth_token_secret]),a(d+"?"+b.text)},b)},fetchAccessToken:function(a,b){var c=this;this.get(this.accessTokenUrl,function(b){var d=c.parseTokenRequest(b,b.responseHeaders["Content-Type"]||void 0);c.setAccessToken([d.oauth_token,d.oauth_token_secret]),c.setVerifier(""),a(b)},b)}},g.signatureMethod={"HMAC-SHA1":function(b,c,d){var e,f,h=g.urlEncode;return b=h(b),c=h(c||""),e=b+"&"+c,f=t(s.prototype,e,d),a.btoa(f)}},g.urlEncode=function(a){function b(a){var b=a.toString(16).toUpperCase();return b.length<2&&(b=0+b),"%"+b}if(!a)return"";a+="";var e,g,c=/[ \t\r\n!*"'();:@&=+$,\/?%#\[\]<>{}|`^\\\u0080-\uffff]/,d=a.length,f=a.split("");for(e=0;d>e;e++)(g=f[e].match(c))&&(g=g[0].charCodeAt(0),128>g?f[e]=b(g):2048>g?f[e]=b(192+(g>>6))+b(128+(63&g)):65536>g?f[e]=b(224+(g>>12))+b(128+(63&g>>6))+b(128+(63&g)):2097152>g&&(f[e]=b(240+(g>>18))+b(128+(63&g>>12))+b(128+(63&g>>6))+b(128+(63&g))));return f.join("")},g.urlDecode=function(a){return a?a.replace(/%[a-fA-F0-9]{2}/gi,function(a){return String.fromCharCode(parseInt(a.replace("%",""),16))}):""},s.prototype=new s,s.prototype.blocksize=64,s.prototype.hash=function(a){function A(a,b,c,d){switch(a){case 0:return b&c|~b&d;case 1:case 3:return b^c^d;case 2:return b&c|b&d|c&d}return-1}var d,e,f,g,h,i,j,k,l,p,q,s,t,u,v,w,x,y,z,b=[1732584193,4023233417,2562383102,271733878,3285377520],c=[1518500249,1859775393,2400959708,3395469782];for(a.constructor===String&&(a=n(a.encodeUTF8())),f=a.length,g=Math.ceil((f+9)/this.blocksize)*this.blocksize-(f+9),e=Math.floor(f/4294967296),d=Math.floor(f%4294967296),h=[255&8*e>>24,255&8*e>>16,255&8*e>>8,255&8*e,255&8*d>>24,255&8*d>>16,255&8*d>>8,255&8*d],a=a.concat([128],m(g),h),i=Math.ceil(a.length/this.blocksize),j=0;i>j;j++){for(k=a.slice(j*this.blocksize,(j+1)*this.blocksize),l=k.length,p=[],q=0;l>q;q++)p[q>>>2]|=k[q]<<24-8*(q-4*(q>>2));for(s=b[0],t=b[1],u=b[2],v=b[3],w=b[4],x=0;80>x;x++)x>=16&&(p[x]=r(p[x-3]^p[x-8]^p[x-14]^p[x-16],1)),y=Math.floor(x/20),z=r(s,5)+A(y,t,u,v)+w+c[y]+p[x],w=v,v=u,u=r(t,30),t=s,s=z;b[0]+=s,b[1]+=t,b[2]+=u,b[3]+=v,b[4]+=w}return o(b)},g}(exports);var exports=exports||this;!function(a){var b="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";a.btoa=a.btoa||function(a){for(var e,f,c=0,d=a.length,g="";d>c;c+=3)e=[a.charCodeAt(c),a.charCodeAt(c+1),a.charCodeAt(c+2)],f=[e[0]>>2,(3&e[0])<<4|e[1]>>4,(15&e[1])<<2|e[2]>>6,63&e[2]],isNaN(e[1])&&(f[2]=64),isNaN(e[2])&&(f[3]=64),g+=b.charAt(f[0])+b.charAt(f[1])+b.charAt(f[2])+b.charAt(f[3]);return g}}(exports);;
var exports=exports||this;exports.Google=function(){function e(){var e=this,t=this.oauthClient,o=Ti.UI.createWindow({title:this.windowTitle}),n=Ti.UI.createWebView(),i=Ti.UI.createView({backgroundColor:"black",opacity:.7,zIndex:1}),r=Titanium.UI.createActivityIndicator({height:50,width:10,message:"Loading...",color:"white"}),c=Ti.UI.createButton({title:this.windowClose}),a=Ti.UI.createButton({title:this.windowBack});this.webView=n,o.leftNavButton=c,r.show(),i.add(r),o.add(i),o.open({modal:!0}),o.add(n),c.addEventListener("click",function(){o.close(),e.fireEvent("cancel",{success:!1,error:"The user cancelled.",result:null})}),a.addEventListener("click",function(){n.goBack()}),n.addEventListener("beforeload",function(){s||o.add(i),r.show()}),n.addEventListener("load",function(n){if(-1!==n.url.indexOf("https://accounts.google.com/o/oauth2/approval")){o.remove(i),r.hide(),o.leftNavButton!==a&&(o.leftNavButton=a),s||o.close();var u=n.source.evalJS("document.getElementsByTagName('title')[0].innerText").split("=")[1];t.post("https://accounts.google.com/o/oauth2/token",{grant_type:"authorization_code",client_id:e.consumerKey,client_secret:e.consumerSecret,code:u,redirect_uri:e.callbackUrl},function(n){var i=JSON.parse(n.text);t.setAccessToken([i.access_token]),e.accessTokenKey=i.access_token,e.refreshTokenKey=i.refresh_token,e.fireEvent("login",{success:!0,error:!1,accessTokenKey:t.getAccessTokenKey(),refreshTokenKey:e.refreshTokenKey,expiresIn:i.expires_in}),e.authorized=!0,s&&o.close()})}else o.remove(i),r.hide(),o.leftNavButton!==c&&(o.leftNavButton=c)})}var t=function(){},s="android"===Ti.Platform.osname,o={OAuth:exports.OAuth},n=function(e){var s;return s=this instanceof n?this:new t,e||(e={}),s.windowTitle=e.windowTitle||"Google Authorization",s.windowClose=e.windowClose||"Close",s.windowBack=e.windowBack||"Back",s.consumerKey=e.consumerKey,s.consumerSecret=e.consumerSecret,s.accessTokenKey=e.accessTokenKey,s.refreshTokenKey=e.refreshTokenKey,s.scope=e.scope,s.authorized=!1,s.listeners={},s.accessTokenKey&&s.refreshTokenKey&&(s.authorized=!0),s.callbackUrl=e.callbackUrl||"urn:ietf:wg:oauth:2.0:oob",e.requestTokenUrl=e.requestTokenUrl||"https://accounts.google.com/o/oauth2/auth",s.oauthClient=o.OAuth(e),s};return t.prototype=n.prototype,n.prototype.authorize=function(){var t=this;this.authorized?this.oauthClient.post("https://accounts.google.com/o/oauth2/token",{grant_type:"refresh_token",client_id:this.consumerKey,client_secret:this.consumerSecret,refresh_token:this.refreshTokenKey},function(e){var s=JSON.parse(e.text);t.oauthClient.setAccessToken([s.access_token]),t.accessTokenKey=s.access_token,t.refreshTokenKey=s.refresh_token,t.fireEvent("login",{success:!0,error:!1,accessTokenKey:t.oauthClient.getAccessTokenKey(),refreshTokenKey:t.refreshTokenKey,expiresIn:s.expires_in})},function(){t.oauthClient.setAccessToken([null]),t.accessTokenKey=null,t.refreshTokenKey=null,t.fireEvent("login",{success:!1,error:!0})}):(e.call(this),this.oauthClient.setAccessToken("",""),t.webView.url=this.oauthClient.requestTokenUrl+"?client_id="+this.consumerKey+"&redirect_uri="+this.callbackUrl+"&scope="+this.scope+"&response_type=code")},n.prototype.request=function(e,t,s,o,n){var i=this,r=this.oauthClient,c=e;s.Authorization="OAuth "+r.getAccessTokenKey(),r.request({method:o,url:c,data:t,headers:s,success:function(e){n.call(i,{success:!0,error:!1,result:e})},failure:function(e){n.call(i,{success:!1,error:"Request failed",result:e})}})},n.prototype.logout=function(e){this.oauthClient.setAccessToken("",""),this.accessTokenKey=null,this.refreshTokenKey=null,this.authorized=!1,e()},n.prototype.addEventListener=function(e,t){this.listeners=this.listeners||{},this.listeners[e]=this.listeners[e]||[],this.listeners[e].push(t)},n.prototype.fireEvent=function(e,t){for(var s=this.listeners[e]||[],o=0;o<s.length;o++)s[o].call(this,t)},n.prototype.refreshAccessToken=function(){var e=this;e.oauthClient.post("https://accounts.google.com/o/oauth2/token",{grant_type:"refresh_token",client_id:e.consumerKey,client_secret:e.consumerSecret,refresh_token:e.refreshTokenKey},function(t){var s=JSON.parse(t.text);e.oauthClient.setAccessToken([s.access_token]),e.accessTokenKey=s.access_token,e.refreshTokenKey=s.refresh_token,e.fireEvent("refresh",{success:!0,error:!1,accessTokenKey:e.oauthClient.getAccessTokenKey(),refreshTokenKey:e.refreshTokenKey,expiresIn:s.expires_in})},function(){e.fireEvent("refresh",{success:!1,error:!0})})},n}(this);var exports=exports||this;exports.Linkedin=function(){function e(){var e=this,t=this.oauthClient,o=Ti.UI.createWindow({title:this.windowTitle}),n=Ti.UI.createWebView(),i=Ti.UI.createView({backgroundColor:"black",opacity:.7,zIndex:1}),r=Titanium.UI.createActivityIndicator({height:50,width:10,message:"Loading...",color:"white"}),c=Ti.UI.createButton({title:this.windowClose}),a=Ti.UI.createButton({title:this.windowBack});this.webView=n,o.leftNavButton=c,r.show(),i.add(r),o.add(i),o.open({modal:!0}),o.add(n),c.addEventListener("click",function(){o.close(),e.fireEvent("cancel",{success:!1,error:"The user cancelled.",result:null})}),a.addEventListener("click",function(){n.goBack()}),n.addEventListener("beforeload",function(){s||o.add(i),r.show()}),n.addEventListener("load",function(n){if(-1===n.url.indexOf(e.authorizeUrl))o.remove(i),r.hide(),o.leftNavButton!==a&&(o.leftNavButton=a);else{o.leftNavButton!==c&&(o.leftNavButton=c);var u=n.source.evalJS("document.getElementsByClassName('access-code')[0].innerText");u?(s||o.close(),t.accessTokenUrl="https://api.linkedin.com/uas/oauth/accessToken?oauth_verifier="+u,t.fetchAccessToken(function(){e.fireEvent("login",{success:!0,error:!1,accessTokenKey:t.getAccessTokenKey(),accessTokenSecret:t.getAccessTokenSecret()}),e.authorized=!0,s&&o.close()},function(t){e.fireEvent("login",{success:!1,error:"Failure to fetch access token, please try again.",result:t})})):(o.remove(i),r.hide())}})}var t=function(){},s="android"===Ti.Platform.osname,o={OAuth:exports.OAuth},n=function(e){var s;return s=this instanceof n?this:new t,e||(e={}),s.windowTitle=e.windowTitle||"Linkedin Authorization",s.windowClose=e.windowClose||"Close",s.windowBack=e.windowBack||"Back",s.consumerKey=e.consumerKey,s.consumerSecret=e.consumerSecret,s.authorizeUrl="https://www.linkedin.com/uas/oauth/authorize",s.accessTokenKey=e.accessTokenKey,s.accessTokenSecret=e.accessTokenSecret,s.scope=e.scope,s.authorized=!1,s.listeners={},s.accessTokenKey&&(s.authorized=!0),s.callbackUrl=e.callbackUrl||"oob",e.requestTokenUrl=e.requestTokenUrl||"https://api.linkedin.com/uas/oauth/requestToken",s.oauthClient=o.OAuth(e),s};return t.prototype=n.prototype,n.prototype.authorize=function(){var t=this;this.authorized?setTimeout(function(){t.fireEvent("login",{success:!0,error:!1,accessTokenKey:t.accessTokenKey,accessTokenSecret:t.accessTokenSecret})},1):(e.call(this),this.oauthClient.fetchRequestToken(function(e){var s=t.authorizeUrl+e;t.webView.url=s},function(e){t.fireEvent("login",{success:!1,error:"Failure to fetch access token, please try again.",result:e})}))},n.prototype.request=function(e,t,s,o,n){var i,r=this,c=this.oauthClient;i=e.match(/^https?:\/\/.+/i)?e:"https://api.linkedin.com/"+e,t.access_token=this.accessTokenKey,c.request({method:o,url:i,data:t,headers:s,success:function(e){n.call(r,{success:!0,error:!1,result:e})},failure:function(e){n.call(r,{success:!1,error:"Request failed",result:e})}})},n.prototype.logout=function(e){this.oauthClient.setAccessToken("",""),this.accessTokenKey=null,this.accessTokenSecret=null,this.authorized=!1,e()},n.prototype.addEventListener=function(e,t){this.listeners=this.listeners||{},this.listeners[e]=this.listeners[e]||[],this.listeners[e].push(t)},n.prototype.fireEvent=function(e,t){for(var s=this.listeners[e]||[],o=0;o<s.length;o++)s[o].call(this,t)},n}(this);var exports=exports||this;exports.Twitter=function(){function e(){var e=this,t=this.oauthClient,o=Ti.UI.createWindow({title:this.windowTitle}),n=Ti.UI.createWebView(),i=Ti.UI.createView({backgroundColor:"black",opacity:.7,zIndex:1}),r=Titanium.UI.createActivityIndicator({height:50,width:10,message:"Loading...",color:"white"}),c=Ti.UI.createButton({title:this.windowClose}),a=Ti.UI.createButton({title:this.windowBack});this.webView=n,o.leftNavButton=c,r.show(),i.add(r),o.add(i),o.open({modal:!0}),o.add(n),c.addEventListener("click",function(){o.close(),e.fireEvent("cancel",{success:!1,error:"The user cancelled.",result:null})}),a.addEventListener("click",function(){n.goBack()}),n.addEventListener("beforeload",function(){s||o.add(i),r.show()}),n.addEventListener("load",function(n){if(-1===n.url.indexOf(e.authorizeUrl))o.remove(i),r.hide(),o.leftNavButton!==a&&(o.leftNavButton=a);else{o.leftNavButton!==c&&(o.leftNavButton=c);var u=n.source.evalJS("document.getElementById('oauth_pin').getElementsByTagName('code')[0].innerText");u?(s||o.close(),t.accessTokenUrl="https://api.twitter.com/oauth/access_token?oauth_verifier="+u,t.fetchAccessToken(function(){e.fireEvent("login",{success:!0,error:!1,accessTokenKey:t.getAccessTokenKey(),accessTokenSecret:t.getAccessTokenSecret()}),e.authorized=!0,s&&o.close()},function(t){e.fireEvent("login",{success:!1,error:"Failure to fetch access token, please try again.",result:t})})):(o.remove(i),r.hide())}})}var t=function(){},s="android"===Ti.Platform.osname,o={OAuth:exports.OAuth},n=function(e){var s;return s=this instanceof n?this:new t,e||(e={}),s.windowTitle=e.windowTitle||"Twitter Authorization",s.windowClose=e.windowClose||"Close",s.windowBack=e.windowBack||"Back",s.consumerKey=e.consumerKey,s.consumerSecret=e.consumerSecret,s.authorizeUrl="https://api.twitter.com/oauth/authorize",s.accessTokenKey=e.accessTokenKey,s.accessTokenSecret=e.accessTokenSecret,s.authorized=!1,s.listeners={},s.accessTokenKey&&s.accessTokenSecret&&(s.authorized=!0),e.requestTokenUrl=e.requestTokenUrl||"https://api.twitter.com/oauth/request_token",s.oauthClient=o.OAuth(e),s};return t.prototype=n.prototype,n.prototype.authorize=function(){var t=this;this.authorized?setTimeout(function(){t.fireEvent("login",{success:!0,error:!1,accessTokenKey:t.accessTokenKey,accessTokenSecret:t.accessTokenSecret})},1):(e.call(this),this.oauthClient.fetchRequestToken(function(e){var s=t.authorizeUrl+e;t.webView.url=s},function(e){t.fireEvent("login",{success:!1,error:"Failure to fetch access token, please try again.",result:e})}))},n.prototype.request=function(e,t,s,o,n){var i,r=this,c=this.oauthClient;i=e.match(/^https?:\/\/.+/i)?e:"https://api.twitter.com/"+e,c.request({method:o,url:i,data:t,headers:s,success:function(e){n.call(r,{success:!0,error:!1,result:e})},failure:function(e){n.call(r,{success:!1,error:"Request failed",result:e})}})},n.prototype.logout=function(e){this.oauthClient.setAccessToken("",""),this.accessTokenKey=null,this.accessTokenSecret=null,this.authorized=!1,e()},n.prototype.addEventListener=function(e,t){this.listeners=this.listeners||{},this.listeners[e]=this.listeners[e]||[],this.listeners[e].push(t)},n.prototype.fireEvent=function(e,t){for(var s=this.listeners[e]||[],o=0;o<s.length;o++)s[o].call(this,t)},n}(this);;
}.call(this));;
/*!
 * Copyright (c) 2015 Kinvey, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *    http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
(function(){var a=this,b=function(){var c=function(a){var c=b();return null!=a&&c.init(a),c};c.API_ENDPOINT="https://baas.kinvey.com",c.API_VERSION="3",c.SDK_VERSION="1.1.11",c.appKey=null,c.appSecret=null,c.masterSecret=null;var d="appdata",e="blob",f="rpc",g="user",h=null,i=!1,j=function(a){var b=y.get("activeUser");return b.then(function(b){if(null==b)return c.setActiveUser(null);var d=c.setActiveUser({_id:b[0],_kmd:{authtoken:b[1]}});if(!1===a.refresh)return c.getActiveUser();var e=a.success,f=a.error;return delete a.success,delete a.error,c.User.me(a).then(function(b){return a.success=e,a.error=f,b},function(b){return c.Error.INVALID_CREDENTIALS===b.name&&c.setActiveUser(d),a.success=e,a.error=f,c.Defer.reject(b)})})};c.getActiveUser=function(){if(!1===i)throw new c.Error("Kinvey.getActiveUser can only be called after the promise returned by Kinvey.init fulfills or rejects.");return h},c.setActiveUser=function(a){if(null!=a&&(null==a._id||null==a._kmd||null==a._kmd.authtoken))throw new c.Error("user argument must contain: _id, _kmd.authtoken.");!1===i&&(i=!0);var b=c.getActiveUser();return h=a,null!=a?y.save("activeUser",[a._id,a._kmd.authtoken]):y.destroy("activeUser"),b},c.init=function(a){if(a=a||{},null==a.appKey)throw new c.Error("options argument must contain: appKey.");if(null==a.appSecret&&null==a.masterSecret)throw new c.Error("options argument must contain: appSecret and/or masterSecret.");i=!1,c.appKey=a.appKey,c.appSecret=null!=a.appSecret?a.appSecret:null,c.masterSecret=null!=a.masterSecret?a.masterSecret:null,c.encryptionKey=null!=a.encryptionKey?a.encryptionKey:null;var b=c.Sync.init(a.sync).then(function(){return j(a)});return o(b,a)},c.ping=function(a){a=a||{},a.nocache=null==c.appKey?!1:a.nocache;var b=c.Persistence.read({namespace:d,auth:null!=c.appKey?z.All:z.None},a);return o(b,a)},c.Error=function(a){this.name="Kinvey.Error",this.message=a,this.stack=(new Error).stack},c.Error.prototype=new Error,c.Error.prototype.constructor=c.Error,c.Error.ENTITY_NOT_FOUND="EntityNotFound",c.Error.COLLECTION_NOT_FOUND="CollectionNotFound",c.Error.APP_NOT_FOUND="AppNotFound",c.Error.USER_NOT_FOUND="UserNotFound",c.Error.BLOB_NOT_FOUND="BlobNotFound",c.Error.INVALID_CREDENTIALS="InvalidCredentials",c.Error.KINVEY_INTERNAL_ERROR_RETRY="KinveyInternalErrorRetry",c.Error.KINVEY_INTERNAL_ERROR_STOP="KinveyInternalErrorStop",c.Error.USER_ALREADY_EXISTS="UserAlreadyExists",c.Error.USER_UNAVAILABLE="UserUnavailable",c.Error.DUPLICATE_END_USERS="DuplicateEndUsers",c.Error.INSUFFICIENT_CREDENTIALS="InsufficientCredentials",c.Error.WRITES_TO_COLLECTION_DISALLOWED="WritesToCollectionDisallowed",c.Error.INDIRECT_COLLECTION_ACCESS_DISALLOWED="IndirectCollectionAccessDisallowed",c.Error.APP_PROBLEM="AppProblem",c.Error.PARAMETER_VALUE_OUT_OF_RANGE="ParameterValueOutOfRange",c.Error.CORS_DISABLED="CORSDisabled",c.Error.INVALID_QUERY_SYNTAX="InvalidQuerySyntax",c.Error.MISSING_QUERY="MissingQuery",c.Error.JSON_PARSE_ERROR="JSONParseError",c.Error.MISSING_REQUEST_HEADER="MissingRequestHeader",c.Error.INCOMPLETE_REQUEST_BODY="IncompleteRequestBody",c.Error.MISSING_REQUEST_PARAMETER="MissingRequestParameter",c.Error.INVALID_IDENTIFIER="InvalidIdentifier",c.Error.BAD_REQUEST="BadRequest",c.Error.FEATURE_UNAVAILABLE="FeatureUnavailable",c.Error.API_VERSION_NOT_IMPLEMENTED="APIVersionNotImplemented",c.Error.API_VERSION_NOT_AVAILABLE="APIVersionNotAvailable",c.Error.INPUT_VALIDATION_FAILED="InputValidationFailed",c.Error.BL_RUNTIME_ERROR="BLRuntimeError",c.Error.BL_SYNTAX_ERROR="BLSyntaxError",c.Error.BL_TIMEOUT_ERROR="BLTimeoutError",c.Error.OAUTH_TOKEN_REFRESH_ERROR="OAuthTokenRefreshError",c.Error.BL_VIOLATION_ERROR="BLViolationError",c.Error.BL_INTERNAL_ERROR="BLInternalError",c.Error.THIRD_PARTY_TOS_UNACKED="ThirdPartyTOSUnacked",c.Error.STALE_REQUEST="StaleRequest",c.Error.DATA_LINK_PARSE_ERROR="DataLinkParseError",c.Error.NOT_IMPLEMENTED_ERROR="NotImplementedError",c.Error.EMAIL_VERIFICATION_REQUIRED="EmailVerificationRequired",c.Error.SORT_LIMIT_EXCEEDED="SortLimitExceeded",c.Error.INVALID_SHORT_URL="InvalidShortURL",c.Error.INVALID_OR_MISSING_NONCE="InvalidOrMissingNonce",c.Error.MISSING_CONFIGURATION="MissingConfiguration",c.Error.ENDPOINT_DOES_NOT_EXIST="EndpointDoesNotExist",c.Error.DISALLOWED_QUERY_SYNTAX="DisallowedQuerySyntax",c.Error.MALFORMED_AUTHENTICATION_HEADER="MalformedAuthenticationHeader",c.Error.APP_ARCHIVED="AppArchived",c.Error.BL_NOT_SUPPORTED_FOR_ROUTE="BLNotSupportedForRoute",c.Error.USER_LOCKED_DOWN="UserLockedDown",c.Error.ALREADY_LOGGED_IN="AlreadyLoggedIn",c.Error.DATABASE_ERROR="DatabaseError",c.Error.MISSING_APP_CREDENTIALS="MissingAppCredentials",c.Error.MISSING_MASTER_CREDENTIALS="MissingMasterCredentials",c.Error.NO_ACTIVE_USER="NoActiveUser",c.Error.REQUEST_ABORT_ERROR="RequestAbortError",c.Error.REQUEST_ERROR="RequestError",c.Error.REQUEST_TIMEOUT_ERROR="RequestTimeoutError",c.Error.SOCIAL_ERROR="SocialError",c.Error.SYNC_ERROR="SyncError";var k={};k[c.Error.ALREADY_LOGGED_IN]={name:c.Error.ALREADY_LOGGED_IN,description:"You are already logged in with another user.",debug:"If you want to switch users, logout the active user first using `Kinvey.User.logout`, then try again."},k[c.Error.DATABASE_ERROR]={name:c.Error.DATABASE_ERROR,description:"The database used for local persistence encountered an error.",debug:""},k[c.Error.MISSING_APP_CREDENTIALS]={name:c.Error.MISSING_APP_CREDENTIALS,description:"Missing credentials: `Kinvey.appKey` and/or `Kinvey.appSecret`.",debug:"Did you forget to call `Kinvey.init`?"},k[c.Error.MISSING_MASTER_CREDENTIALS]={name:c.Error.MISSING_MASTER_CREDENTIALS,description:"Missing credentials: `Kinvey.appKey` and/or `Kinvey.masterSecret`.",debug:"Did you forget to call `Kinvey.init` with your Master Secret?"},k[c.Error.NO_ACTIVE_USER]={name:c.Error.NO_ACTIVE_USER,description:"You need to be logged in to execute this request.",debug:"Try creating a user using `Kinvey.User.signup`, or login an existing user using `Kinvey.User.login`."},k[c.Error.REQUEST_ABORT_ERROR]={name:c.Error.REQUEST_TIMEOUT_ERROR,description:"The request was aborted.",debug:""},k[c.Error.REQUEST_ERROR]={name:c.Error.REQUEST_ERROR,description:"The request failed.",debug:""},k[c.Error.REQUEST_TIMEOUT_ERROR]={name:c.Error.REQUEST_TIMEOUT_ERROR,description:"The request timed out.",debug:""},k[c.Error.SOCIAL_ERROR]={name:c.Error.SOCIAL_ERROR,description:"The social identity cannot be obtained.",debug:""},k[c.Error.SYNC_ERROR]={name:c.Error.SYNC_ERROR,description:"The synchronization operation cannot be completed.",debug:""};var l,m=function(a,b){var c=k[a]||{name:a};return b=b||{},{name:c.name,description:b.description||c.description||"",debug:b.debug||c.debug||""}},n=function(a,b,c){if(!b)return a="undefined"==typeof c?a:c;for(var d,e=a,f=b.split(".");(d=f.shift())&&null!=e&&e.hasOwnProperty(d);){if(0===f.length)return e[d]="undefined"==typeof c?e[d]:c,e[d];e=e[d]}return null};l="function"==typeof a.setImmediate?a.setImmediate:"undefined"!=typeof process&&process.nextTick?process.nextTick:function(b){a.setTimeout(b,0)};var o=function(a,b){return a.then(function(a){b.success&&b.success(a)},function(a){b.error&&b.error(a)}).then(null,function(a){l(function(){throw a})}),a},p=Array.isArray||function(a){return"[object Array]"===Object.prototype.toString.call(a)},q=function(a){return"function"!=typeof/./?"function"==typeof a:"[object Function]"===Object.prototype.toString.call(a)},r=function(a){return"[object Number]"===Object.prototype.toString.call(a)&&!isNaN(a)},s=function(a){return Object(a)===a},t=function(a){return"[object RegExp]"===Object.prototype.toString.call(a)},u=function(a){return"[object String]"===Object.prototype.toString.call(a)},v=function(a){if(null==a)return!0;if(p(a)||u(a))return 0===a.length;for(var b in a)if(a.hasOwnProperty(b))return!1;return!0},w=function(a){return function(){throw new c.Error("Method not implemented: "+a)}},x=function(a){return function(b){var d=this;b=b||{},a.forEach(function(a){if("function"!=typeof b[a])throw new c.Error("Adapter must implement method: "+a)}),a.forEach(function(a){d[a]=function(){return b[a].apply(b,arguments)}})}},y={destroy:function(a){return y._destroy(y._key(a))},get:function(a){return y._get(y._key(a))},save:function(a,b){return y._save(y._key(a),b)},_destroy:w("Storage.destroy"),_get:w("Storage.get"),_key:function(a){return["Kinvey",c.appKey,a].join(".")},_save:w("Storage.set"),use:x(["_destroy","_get","_save"])};c.Defer={all:function(a){if(!p(a))throw new c.Error("promises argument must be of type: Array.");var b=a.length;if(0===b)return c.Defer.resolve([]);var d=c.Defer.deferred(),e=[];return a.forEach(function(a,c){a.then(function(a){b-=1,e[c]=a,0===b&&d.resolve(e)},function(a){d.reject(a)})}),d.promise},resolve:function(a){var b=c.Defer.deferred();return b.resolve(a),b.promise},reject:function(a){var b=c.Defer.deferred();return b.reject(a),b.promise},deferred:w("Kinvey.Defer.deferred"),use:x(["deferred"])};var z={All:function(){return z.Session().then(null,z.Basic)},App:function(){if(null==c.appKey||null==c.appSecret){var a=m(c.Error.MISSING_APP_CREDENTIALS);return c.Defer.reject(a)}var b=c.Defer.resolve({scheme:"Basic",username:c.appKey,password:c.appSecret});return b},Basic:function(){return z.Master().then(null,z.App)},Default:function(){return z.Session().then(null,function(a){return z.Master().then(null,function(){return c.Defer.reject(a)})})},Master:function(){if(null==c.appKey||null==c.masterSecret){var a=m(c.Error.MISSING_MASTER_CREDENTIALS);return c.Defer.reject(a)}var b=c.Defer.resolve({scheme:"Basic",username:c.appKey,password:c.masterSecret});return b},None:function(){return c.Defer.resolve(null)},Session:function(){var a=c.getActiveUser();if(null===a){var b=m(c.Error.NO_ACTIVE_USER);return c.Defer.reject(b)}var d=c.Defer.resolve({scheme:"Kinvey",credentials:a._kmd.authtoken});return d}},A=function(){var b,c,d,e,f,g=[],h=function(a){a=a.toLowerCase();var b=/(chrome)\/([\w]+)/,c=/(firefox)\/([\w.]+)/,d=/(msie) ([\w.]+)/i,e=/(opera)(?:.*version)?[ \/]([\w.]+)/,f=/(safari)\/([\w.]+)/;return b.exec(a)||c.exec(a)||d.exec(a)||e.exec(a)||f.exec(a)||[]};if("undefined"!=typeof a.cordova&&"undefined"!=typeof a.device){var i=a.device;g.push("phonegap/"+i.cordova),c=i.platform,d=i.version,e=i.model,f=i.uuid}else"undefined"!=typeof Titanium?(g.push("titanium/"+Titanium.getVersion()),"mobileweb"===Titanium.Platform.getName()?(b=h(Titanium.Platform.getModel()),c=b[1],d=b[2],e=Titanium.Platform.getOstype()):(c=Titanium.Platform.getOsname(),d=Titanium.Platform.getVersion(),e=Titanium.Platform.getManufacturer()),f=Titanium.Platform.getId()):"undefined"!=typeof forge?(g.push("triggerio/"+(forge.config.platform_version||"")),f=forge.config.uuid):"undefined"!=typeof process&&(c=process.title,d=process.version,e=process.platform);"undefined"!=typeof angular&&g.push("angularjs/"+angular.version.full),"undefined"!=typeof Backbone&&g.push("backbonejs/"+Backbone.VERSION),"undefined"!=typeof Ember&&g.push("emberjs/"+Ember.VERSION),"undefined"!=typeof jQuery&&g.push("jquery/"+jQuery.fn.jquery),"undefined"!=typeof ko&&g.push("knockout/"+ko.version),"undefined"!=typeof Zepto&&g.push("zeptojs"),null==c&&a.navigator&&(b=h(a.navigator.userAgent),c=b[1],d=b[2],e=a.navigator.platform);var j=["js-titanium/1.1.11"];return 0!==g.length&&j.push("("+g.sort().join(", ")+")"),j.concat([c,d,e,f].map(function(a){return null!=a?a.toString().replace(/\s/g,"_").toLowerCase():"unknown"})).join(" ")};c.Acl=function(a){if(null!=a&&!s(a))throw new c.Error("document argument must be of type: Object.");a=a||{},a._acl=a._acl||{},this._acl=a._acl},c.Acl.prototype={addReader:function(a){return this._acl.r=this._acl.r||[],-1===this._acl.r.indexOf(a)&&this._acl.r.push(a),this},addReaderGroup:function(a){return this._acl.groups=this._acl.groups||{},this._acl.groups.r=this._acl.groups.r||[],-1===this._acl.groups.r.indexOf(a)&&this._acl.groups.r.push(a),this},addWriterGroup:function(a){return this._acl.groups=this._acl.groups||{},this._acl.groups.w=this._acl.groups.w||[],-1===this._acl.groups.w.indexOf(a)&&this._acl.groups.w.push(a),this},addWriter:function(a){return this._acl.w=this._acl.w||[],-1===this._acl.w.indexOf(a)&&this._acl.w.push(a),this},getCreator:function(){return this._acl.creator||null},getReaders:function(){return this._acl.r||[]},getReaderGroups:function(){return this._acl.groups?this._acl.groups.r:[]},getWriterGroups:function(){return this._acl.groups?this._acl.groups.w:[]},getWriters:function(){return this._acl.w||[]},isGloballyReadable:function(){return this._acl.gr||!1},isGloballyWritable:function(){return this._acl.gw||!1},removeReader:function(a){var b;return this._acl.r&&-1!==(b=this._acl.r.indexOf(a))&&this._acl.r.splice(b,1),this},removeReaderGroup:function(a){var b;return this._acl.groups&&this._acl.groups.r&&-1!==(b=this._acl.groups.r.indexOf(a))&&this._acl.groups.r.splice(b,1),this},removeWriterGroup:function(a){var b;return this._acl.groups&&this._acl.groups.w&&-1!==(b=this._acl.groups.w.indexOf(a))&&this._acl.groups.w.splice(b,1),this},removeWriter:function(a){var b;return this._acl.w&&-1!==(b=this._acl.w.indexOf(a))&&this._acl.w.splice(b,1),this},setGloballyReadable:function(a){return this._acl.gr=a||!1,this},setGloballyWritable:function(a){return this._acl.gw=a||!1,this},toJSON:function(){return this._acl}},c.Group=function(){this._query=null,this._initial={},this._key={},this._reduce=function(){}.toString()},c.Group.prototype={by:function(a){return this._key[a]=!0,this},initial:function(a,b){if("undefined"==typeof b&&!s(a))throw new c.Error("objectOrKey argument must be of type: Object.");return s(a)?this._initial=a:this._initial[a]=b,this},postProcess:function(a){return null===this._query?a:this._query._postProcess(a)},query:function(a){if(!(a instanceof c.Query))throw new c.Error("query argument must be of type: Kinvey.Query.");return this._query=a,this},reduce:function(a){if(q(a)&&(a=a.toString()),!u(a))throw new c.Error("fn argument must be of type: function or string.");return this._reduce=a,this},toJSON:function(){return{key:this._key,initial:this._initial,reduce:this._reduce,condition:null!==this._query?this._query.toJSON().filter:{}}}},c.Group.count=function(a){var b=new c.Group;return null!=a&&b.by(a),b.initial({result:0}),b.reduce(function(a,b){b.result+=1}),b},c.Group.sum=function(a){a=a.replace("'","\\'");var b=new c.Group;return b.initial({result:0}),b.reduce('function(doc, out) { out.result += doc["'+a+'"]; }'),b},c.Group.min=function(a){a=a.replace("'","\\'");var b=new c.Group;return b.initial({result:"Infinity"}),b.reduce('function(doc, out) { out.result = Math.min(out.result, doc["'+a+'"]); }'),b},c.Group.max=function(a){a=a.replace("'","\\'");var b=new c.Group;return b.initial({result:"-Infinity"}),b.reduce('function(doc, out) { out.result = Math.max(out.result, doc["'+a+'"]); }'),b},c.Group.average=function(a){a=a.replace("'","\\'");var b=new c.Group;return b.initial({count:0,result:0}),b.reduce('function(doc, out) {  out.result = (out.result * out.count + doc["'+a+'"]) / (out.count + 1);  out.count += 1;}'),b},c.execute=function(a,b,d){d=d||{};var e=c.Persistence.create({namespace:f,collection:"custom",id:a,data:b,auth:z.Default},d).then(null,function(a){return c.Defer.reject(c.Error.REQUEST_ERROR===a.name&&s(a.debug)?a.debug:a)});return o(e,d)},c.DataStore={find:function(a,b,e){if(null!=b&&!(b instanceof c.Query))throw new c.Error("query argument must be of type: Kinvey.Query.");e=e||{};var f=c.Persistence.read({namespace:d,collection:a,query:b,auth:z.Default,local:{req:!0,res:!0}},e);return o(f,e)},get:function(a,b,e){e=e||{};var f=c.Persistence.read({namespace:d,collection:a,id:b,auth:z.Default,local:{req:!0,res:!0}},e);return o(f,e)},save:function(a,b,e){if(e=e||{},null!=b._id)return c.DataStore.update(a,b,e);var f=c.Persistence.create({namespace:d,collection:a,data:b,auth:z.Default,local:{req:!0,res:!0}},e);return o(f,e)},update:function(a,b,e){if(null==b._id)throw new c.Error("document argument must contain: _id");e=e||{};var f=c.Persistence.update({namespace:d,collection:a,id:b._id,data:b,auth:z.Default,local:{req:!0,res:!0}},e);return o(f,e)},clean:function(a,b,e){if(e=e||{},b=b||new c.Query,!(b instanceof c.Query))throw new c.Error("query argument must be of type: Kinvey.Query.");var f=c.Persistence.destroy({namespace:d,collection:a,query:b,auth:z.Default,local:{req:!0,res:!0}},e);return o(f,e)},destroy:function(a,b,e){e=e||{};var f=c.Persistence.destroy({namespace:d,collection:a,id:b,auth:z.Default,local:{req:!0,res:!0}},e).then(null,function(a){return e.silent&&c.Error.ENTITY_NOT_FOUND===a.name?{count:0}:c.Defer.reject(a)});return o(f,e)},count:function(a,b,e){if(null!=b&&!(b instanceof c.Query))throw new c.Error("query argument must be of type: Kinvey.Query.");e=e||{};var f=c.Persistence.read({namespace:d,collection:a,id:"_count",query:b,auth:z.Default,local:{req:!0}},e).then(function(a){return a.count});return o(f,e)},group:function(a,b,e){if(!(b instanceof c.Group))throw new c.Error("aggregation argument must be of type: Kinvey.Group.");e=e||{};var f=c.Persistence.create({namespace:d,collection:a,id:"_group",data:b.toJSON(),auth:z.Default,local:{req:!0}},e).then(function(a){return b.postProcess(a)});return o(f,e)}},c.File={destroy:function(a,b){b=b||{};var d=c.Persistence.destroy({namespace:e,id:a,auth:z.Default},b).then(null,function(a){return b.silent&&c.Error.BLOB_NOT_FOUND===a.name?{count:0}:c.Defer.reject(a)});return o(d,b)},download:function(a,b){b=b||{};var d={};!1!==b.tls&&(d.tls=!0),b.ttl&&(d.ttl_in_seconds=b.ttl);var f=c.Persistence.read({namespace:e,id:a,flags:d,auth:z.Default},b).then(function(a){if(b.stream)return a;var d=b.success,e=b.error;return delete b.success,delete b.error,c.File.downloadByUrl(a,b).then(function(a){return b.success=d,b.error=e,a},function(a){return b.success=d,b.error=e,c.Defer.reject(a)})});return o(f,b)},downloadByUrl:function(a,b){var d=s(a)?a:{_downloadURL:a};b=b||{},b.file=d.mimeType||"application-octet-stream",b.headers=b.headers||{},delete b.headers["Content-Type"];var e=d._downloadURL,f=c.Persistence.Net.request("GET",e,null,b.headers,b);return f=f.then(function(a){return d._data=a,d},function(a){var b=m(c.Error.REQUEST_ERROR,{description:"This file could not be downloaded from the provided URL.",debug:a});return c.Defer.reject(b)}),o(f,b)},find:function(a,b){if(null!=a&&!(a instanceof c.Query))throw new c.Error("query argument must be of type: Kinvey.Query.");b=b||{};var d={};!1!==b.tls&&(d.tls=!0),b.ttl&&(d.ttl_in_seconds=b.ttl);var f=c.Persistence.read({namespace:e,query:a,flags:d,auth:z.Default},b).then(function(a){if(b.download){var d=b.success,e=b.error;delete b.success,delete b.error;var f=a.map(function(a){return c.File.downloadByUrl(a,b)});return c.Defer.all(f).then(function(a){return b.success=d,b.error=e,a},function(a){return b.success=d,b.error=e,c.Defer.reject(a)})}return a});return o(f,b)},stream:function(a,b){return b=b||{},b.stream=!0,c.File.download(a,b)},upload:function(a,b,d){a=a||{},b=b||{},d=d||{},null!=b._filename||null==a._filename&&null==a.name||(b._filename=a._filename||a.name),null!=b.size||null==a.size&&null==a.length||(b.size=a.size||a.length),b.mimeType=b.mimeType||a.mimeType||a.type||"application/octet-stream",d["public"]&&(b._public=!0),d.contentType=b.mimeType;var f=null!=b._id?c.Persistence.update({namespace:e,id:b._id,data:b,flags:!1!==d.tls?{tls:!0}:null,auth:z.Default},d):c.Persistence.create({namespace:e,data:b,flags:!1!==d.tls?{tls:!0}:null,auth:z.Default},d);return f=f.then(function(b){var e=b._uploadURL,f=b._requiredHeaders||{};f["Content-Type"]=d.contentType,delete b._expiresAt,delete b._requiredHeaders,delete b._uploadURL;var g=c.Persistence.Net.request("PUT",e,a,f,d);return g.then(function(){return b._data=a,b})}),o(f,d)}};var B=function(b){var c=Date.parse(b);if(c)return new Date(c);var d=/^(\d{4}\-\d\d\-\d\d([tT][\d:\.]*)?)([zZ]|([+\-])(\d\d):?(\d\d))?$/,e=b.match(d);if(null!=e[1]){var f=e[1].split(/\D/).map(function(b){return a.parseInt(b,10)||0});if(f[1]-=1,f=new Date(Date.UTC.apply(Date,f)),null!=e[5]){var g=a.parseInt(e[5],10)/100*60;g+=null!=e[6]?a.parseInt(e[6],10):0,g*="+"===e[4]?-1:1,g&&f.setUTCMinutes(f.getUTCMinutes()*g)}return f}return 0/0};c.Metadata=function(a){if(!s(a))throw new c.Error("document argument must be of type: Object.");this._acl=null,this._document=a},c.Metadata.prototype={getAcl:function(){return null===this._acl&&(this._acl=new c.Acl(this._document)),this._acl},getCreatedAt:function(){return null!=this._document._kmd&&null!=this._document._kmd.ect?B(this._document._kmd.ect):null},getEmailVerification:function(){return null!=this._document._kmd&&null!=this._document._kmd.emailVerification?this._document._kmd.emailVerification.status:null},getLastModified:function(){return null!=this._document._kmd&&null!=this._document._kmd.lmt?B(this._document._kmd.lmt):null},setAcl:function(a){if(!(a instanceof c.Acl))throw new c.Error("acl argument must be of type: Kinvey.Acl.");return this._acl=null,this._document._acl=a.toJSON(),this},toJSON:function(){return this._document}};var C=["facebook","google","linkedIn","twitter"],D={use:x(C)};C.forEach(function(a){D[a]=w("Social."+a)}),c.Social={connect:function(a,b,d){if(d=d||{},d.create="undefined"!=typeof d.create?d.create:!0,!c.Social.isSupported(b))throw new c.Error("provider argument is not supported.");var e=d.success,f=d.error;delete d.success,delete d.error;var g=D[b](d).then(function(e){a=a||{};var f=c.getActiveUser();return a._socialIdentity=a._socialIdentity||{},a._socialIdentity[b]=e,null!==f&&f._id===a._id?(d._provider=b,c.User.update(a,d)):(a._socialIdentity={},a._socialIdentity[b]=e,c.User.login(a,null,d).then(null,function(b){return d.create&&c.Error.USER_NOT_FOUND===b.name?c.User.signup(a,d):c.Defer.reject(b)}))});return g=g.then(function(a){return d.success=e,d.error=f,a}),o(g,d)},disconnect:function(a,b,d){if(!c.Social.isSupported(b))throw new c.Error("provider argument is not supported.");if(a._socialIdentity=a._socialIdentity||{},a._socialIdentity[b]=null,null==a._id){var e=c.Defer.resolve(a);return o(e,d)}return c.User.update(a,d)},facebook:function(a,b){return c.Social.connect(a,"facebook",b)},google:function(a,b){return c.Social.connect(a,"google",b)},isSupported:function(a){return-1!==C.indexOf(a)},linkedIn:function(a,b){return c.Social.connect(a,"linkedIn",b)},twitter:function(a,b){return c.Social.connect(a,"twitter",b)}},c.User={signup:function(a,b){return b=b||{},b.state=!0,c.User.create(a,b)},signupWithProvider:function(a,b,d){var e={_socialIdentity:{}};return e._socialIdentity[a]=b,c.User.signup(e,d)},login:function(a,b,d){if(s(a)?d="undefined"!=typeof d?d:b:a={username:a,password:b},d=d||{},null==a.username&&null==a.password&&null==a._socialIdentity)throw new c.Error("Argument must contain: username and password, or _socialIdentity.");if(null!==c.getActiveUser()){var e=m(c.Error.ALREADY_LOGGED_IN);return o(c.Defer.reject(e),d)}var f=c.Persistence.create({namespace:g,collection:d._provider?null:"login",data:a,flags:d._provider?{provider:d._provider}:{},auth:z.App,local:{res:!0}},d).then(function(a){return c.setActiveUser(a),a});return o(f,d)},loginWithProvider:function(a,b,d){var e={_socialIdentity:{}};return e._socialIdentity[a]=b,c.User.login(e,d)},logout:function(a){a=a||{};var b;return b=a.silent&&null===c.getActiveUser()?c.Defer.resolve(null):c.Persistence.create({namespace:g,collection:"_logout",auth:z.Session},a).then(null,function(b){return!a.force||c.Error.INVALID_CREDENTIALS!==b.name&&c.Error.EMAIL_VERIFICATION_REQUIRED!==b.name?c.Defer.reject(b):null}).then(function(){var a=c.setActiveUser(null);return null!==a&&delete a._kmd.authtoken,a}),o(b,a)},me:function(a){a=a||{};var b=c.Persistence.read({namespace:g,collection:"_me",auth:z.Session,local:{req:!0,res:!0}},a).then(function(a){return a._kmd=a._kmd||{},null==a._kmd.authtoken&&(a._kmd.authtoken=c.getActiveUser()._kmd.authtoken),c.setActiveUser(a),a});return o(b,a)},verifyEmail:function(a,b){b=b||{};var d=c.Persistence.create({namespace:f,collection:a,id:"user-email-verification-initiate",auth:z.App},b);return o(d,b)},forgotUsername:function(a,b){b=b||{};var d=c.Persistence.create({namespace:f,id:"user-forgot-username",data:{email:a},auth:z.App},b);return o(d,b)},resetPassword:function(a,b){b=b||{};var d=c.Persistence.create({namespace:f,collection:a,id:"user-password-reset-initiate",auth:z.App},b);return o(d,b)},exists:function(a,b){b=b||{};var d=c.Persistence.create({namespace:f,id:"check-username-exists",data:{username:a},auth:z.App},b).then(function(a){return a.usernameExists});return o(d,b)},create:function(a,b){if(b=b||{},!1!==b.state&&null!==c.getActiveUser()){var d=m(c.Error.ALREADY_LOGGED_IN);return o(c.Defer.reject(d),b)}var e=c.Persistence.create({namespace:g,data:a||{},auth:z.App},b).then(function(a){return!1!==b.state&&c.setActiveUser(a),a});return o(e,b)},update:function(a,b){if(null==a._id)throw new c.Error("data argument must contain: _id");b=b||{};var d=[];if(null!=a._socialIdentity)for(var e in a._socialIdentity)a._socialIdentity.hasOwnProperty(e)&&null!=a._socialIdentity[e]&&e!==b._provider&&(d.push({provider:e,access_token:a._socialIdentity[e].access_token,access_token_secret:a._socialIdentity[e].access_token_secret}),delete a._socialIdentity[e].access_token,delete a._socialIdentity[e].access_token_secret);var f=c.Persistence.update({namespace:g,id:a._id,data:a,auth:z.Default,local:{res:!0}},b).then(function(a){d.forEach(function(b){var c=b.provider;null!=a._socialIdentity&&null!=a._socialIdentity[c]&&["access_token","access_token_secret"].forEach(function(d){null!=b[d]&&(a._socialIdentity[c][d]=b[d])})});var b=c.getActiveUser();return null!==b&&b._id===a._id&&c.setActiveUser(a),a});return o(f,b)},find:function(a,b){if(null!=a&&!(a instanceof c.Query))throw new c.Error("query argument must be of type: Kinvey.Query.");b=b||{};var d;return d=b.discover?c.Persistence.create({namespace:g,collection:"_lookup",data:null!=a?a.toJSON().filter:null,auth:z.Default,local:{req:!0,res:!0}},b):c.Persistence.read({namespace:g,query:a,auth:z.Default,local:{req:!0,res:!0}},b),o(d,b)},get:function(a,b){b=b||{};var d=c.Persistence.read({namespace:g,id:a,auth:z.Default,local:{req:!0,res:!0}},b);return o(d,b)},destroy:function(a,b){b=b||{};var d=c.Persistence.destroy({namespace:g,id:a,flags:b.hard?{hard:!0}:{},auth:z.Default,local:{res:!0}},b).then(function(b){var d=c.getActiveUser();return null!==d&&d._id===a&&c.setActiveUser(null),b},function(a){return b.silent&&c.Error.USER_NOT_FOUND===a.name?null:c.Defer.reject(a)});return o(d,b)},restore:function(a,b){b=b||{};var d=c.Persistence.create({namespace:g,collection:a,id:"_restore",auth:z.Master},b);return o(d,b)},count:function(a,b){if(null!=a&&!(a instanceof c.Query))throw new c.Error("query argument must be of type: Kinvey.Query.");b=b||{};var d=c.Persistence.read({namespace:g,id:"_count",query:a,auth:z.Default,local:{req:!0}},b).then(function(a){return a.count});return o(d,b)},group:function(a,b){if(!(a instanceof c.Group))throw new c.Error("aggregation argument must be of type: Kinvey.Group.");b=b||{};var d=c.Persistence.create({namespace:g,id:"_group",data:a.toJSON(),auth:z.Default,local:{req:!0}},b).then(function(b){return a.postProcess(b)});return o(d,b)}},c.Query=function(a){a=a||{},this._fields=a.fields||[],this._filter=a.filter||{},this._sort=a.sort||{},this._limit=a.limit||null,this._skip=a.skip||0,this._parent=null},c.Query.prototype={equalTo:function(a,b){return this._filter[a]=b,this},contains:function(a,b){if(!p(b))throw new c.Error("values argument must be of type: Array.");return this._addFilter(a,"$in",b)},containsAll:function(a,b){if(!p(b))throw new c.Error("values argument must be of type: Array.");return this._addFilter(a,"$all",b)},greaterThan:function(a,b){if(!r(b)&&!u(b))throw new c.Error("value argument must be of type: number or string.");return this._addFilter(a,"$gt",b)},greaterThanOrEqualTo:function(a,b){if(!r(b)&&!u(b))throw new c.Error("value argument must be of type: number or string.");return this._addFilter(a,"$gte",b)},lessThan:function(a,b){if(!r(b)&&!u(b))throw new c.Error("value argument must be of type: number or string.");return this._addFilter(a,"$lt",b)},lessThanOrEqualTo:function(a,b){if(!r(b)&&!u(b))throw new c.Error("value argument must be of type: number or string.");return this._addFilter(a,"$lte",b)},notEqualTo:function(a,b){return this._addFilter(a,"$ne",b)},notContainedIn:function(a,b){if(!p(b))throw new c.Error("values argument must be of type: Array.");return this._addFilter(a,"$nin",b)},and:function(){return this._join("$and",Array.prototype.slice.call(arguments))},nor:function(){return null!==this._parent&&null!=this._parent._filter.$and?this._parent.nor.apply(this._parent,arguments):this._join("$nor",Array.prototype.slice.call(arguments))},or:function(){return null!==this._parent?this._parent.or.apply(this._parent,arguments):this._join("$or",Array.prototype.slice.call(arguments))},exists:function(a,b){return b="undefined"==typeof b?!0:b||!1,this._addFilter(a,"$exists",b)},mod:function(a,b,d){if(u(b)&&(b=parseFloat(b)),"undefined"==typeof d?d=0:u(d)&&(d=parseFloat(d)),!r(b))throw new c.Error("divisor arguments must be of type: number.");if(!r(d))throw new c.Error("remainder argument must be of type: number.");return this._addFilter(a,"$mod",[b,d])},matches:function(a,b,c){if(t(b)||(b=new RegExp(b)),c=c||{},(b.ignoreCase||c.ignoreCase)&&!1!==c.ignoreCase)throw new Error("ignoreCase flag is not supported.");if(0!==b.source.indexOf("^"))throw new Error("regExp must be an anchored expression.");var d=[];(b.multiline||c.multiline)&&!1!==c.multiline&&d.push("m"),c.extended&&d.push("x"),c.dotMatchesAll&&d.push("s");var e=this._addFilter(a,"$regex",b.source);return 0!==d.length&&this._addFilter(a,"$options",d.join("")),e},near:function(a,b,d){if(!p(b)||null==b[0]||null==b[1])throw new c.Error("coord argument must be of type: Array.<number, number>.");b[0]=parseFloat(b[0]),b[1]=parseFloat(b[1]);var e=this._addFilter(a,"$nearSphere",[b[0],b[1]]);return null!=d&&this._addFilter(a,"$maxDistance",d),e},withinBox:function(a,b,d){if(!p(b)||null==b[0]||null==b[1])throw new c.Error("bottomLeftCoord argument must be of type: Array.<number, number>.");if(!p(d)||null==d[0]||null==d[1])throw new c.Error("upperRightCoord argument must be of type: Array.<number, number>.");b[0]=parseFloat(b[0]),b[1]=parseFloat(b[1]),d[0]=parseFloat(d[0]),d[1]=parseFloat(d[1]);var e=[[b[0],b[1]],[d[0],d[1]]];return this._addFilter(a,"$within",{$box:e})},withinPolygon:function(a,b){if(!p(b)||3>b.length)throw new c.Error("coords argument must be of type: Array.Array.<number, number>.");return b=b.map(function(a){if(null==a[0]||null==a[1])throw new c.Error("coords argument must be of type: Array.Array.<number, number>.");return[parseFloat(a[0]),parseFloat(a[1])]}),this._addFilter(a,"$within",{$polygon:b})},size:function(a,b){if(u(b)&&(b=parseFloat(b)),!r(b))throw new c.Error("size argument must be of type: number.");return this._addFilter(a,"$size",b)},fields:function(a){if(a=a||[],!p(a))throw new c.Error("fields argument must be of type: Array.");return null!==this._parent?this._parent.fields(a):this._fields=a,this},limit:function(a){if(a=a||null,u(a)&&(a=parseFloat(a)),null!=a&&!r(a))throw new c.Error("limit argument must be of type: number.");return null!==this._parent?this._parent.limit(a):this._limit=a,this},skip:function(a){if(u(a)&&(a=parseFloat(a)),!r(a))throw new c.Error("skip argument must be of type: number.");return null!==this._parent?this._parent.skip(a):this._skip=a,this},ascending:function(a){return null!==this._parent?this._parent.ascending(a):this._sort[a]=1,this},descending:function(a){return null!==this._parent?this._parent.descending(a):this._sort[a]=-1,this},sort:function(a){if(null!=a&&!s(a))throw new c.Error("sort argument must be of type: Object.");return null!==this._parent?this._parent.sort(a):this._sort=a||{},this},toJSON:function(){return null!==this._parent?this._parent.toJSON():{fields:this._fields,filter:this._filter,sort:this._sort,skip:this._skip,limit:this._limit}
},_addFilter:function(a,b,c){return s(this._filter[a])||(this._filter[a]={}),this._filter[a][b]=c,this},_join:function(a,b){var d=this;b=b.map(function(a){if(!(a instanceof c.Query)){if(!s(a))throw new c.Error("query argument must be of type: Kinvey.Query[] or Object[].");a=new c.Query(a)}return a.toJSON().filter}),0===b.length&&(d=new c.Query,b=[d.toJSON().filter],d._parent=this);var e={};for(var f in this._filter)this._filter.hasOwnProperty(f)&&(e[f]=this._filter[f],delete this._filter[f]);return this._filter[a]=[e].concat(b),d},_postProcess:function(a){if(!p(a))throw new c.Error("response argument must be of type: Array.");var b=this;return a=a.sort(function(a,c){for(var d in b._sort)if(b._sort.hasOwnProperty(d)){var e=n(a,d),f=n(c,d);if(null!=e&&null==f)return-1;if(null!=f&&null==e)return 1;if(e!==f){var g=b._sort[d];return(f>e?-1:1)*g}}return 0}),null!==this._limit?a.slice(this._skip,this._skip+this._limit):a.slice(this._skip)}};var E=function(a){var b={};for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b},F={get:function(a,b){if(p(a)){var d=a.map(function(a){return F.get(a,E(b))});return c.Defer.all(d)}b=b||{},b.exclude=b.exclude||[],b.relations=b.relations||{};var e=b.error,f=b.relations,h=b.success;delete b.error,delete b.relations,delete b.success;var i={};Object.keys(f).forEach(function(a){var b=i,c=a.split("."),d=c.length;c.forEach(function(a,c){b.keys||(b.keys={}),b.keys[a]||(b.keys[a]={}),b=b.keys[a],c===d-1&&(b.resolve=!0)})});var j=function(a,d){if(d.keys){var e=[];return Object.keys(d.keys).forEach(function(f){var h=d.keys[f];if(h.resolve){var i=p(a[f]),k=(i?a[f]:[a[f]]).map(function(a){if(null==a||"KinveyRef"!==a._type)return c.Defer.resolve(a);var d;return d=g===a._collection?c.User.get(a._id,b):c.DataStore.get(a._collection,a._id,b),d.then(function(a){return j(a,h).then(function(){return a},function(){return a})},function(){return c.Defer.resolve(a)})});e.push(c.Defer.all(k).then(function(b){a[f]=i?b:b[0]}))}else e.push(j(a[f],h))}),c.Defer.all(e)}return c.Defer.resolve()},k=j(a,i);return k.then(function(){return b.error=e,b.relations=f,b.success=h,a},function(a){return b.error=e,b.relations=f,b.success=h,c.Defer.reject(a)})},save:function(a,b,d){if(p(b)){var e=b.map(function(b){return F.save(a,b,E(d))});return c.Defer.all(e)}d=d||{},d.exclude=d.exclude||[],d.relations=d.relations||{};var f=d.error,h=d.relations,i=d.success;delete d.error,delete d.relations,delete d.success;var j=[];h[""]=a,Object.keys(h).forEach(function(a){var b=""===a?0:a.split(".").length;j[b]=(j[b]||[]).concat(a)});var k={},l=c.Defer.resolve(null);return j.reverse().forEach(function(a){l=l.then(function(){var e=a.map(function(a){var e=h[a],f=n(b,a),i=p(f),j=(i?f:[f]).map(function(b){if(null==b||"KinveyRef"===b._type||-1!==d.exclude.indexOf(a))return c.Defer.resolve(b);var f,h=d.offline&&!1===d.track;if(g!==e||h)f=c.DataStore.save(e,b,d);else{var i=null==b._id;d.state=i&&""!==a?d.state||!1:d.state,f=c.User[i?"create":"update"](b,d)}return f.then(null,function(e){return d.force&&""!==a?b:c.Defer.reject(e)})});return c.Defer.all(j).then(function(c){var d=c.map(function(a){return null==a||null==a._id?a:{_type:"KinveyRef",_collection:e,_id:a._id}});i||(d=d[0],c=c[0]),n(b,a,d),k[a]=c})});return c.Defer.all(e)})}),l.then(function(){var a=k[""];return j.reverse().forEach(function(b){b.forEach(function(b){n(a,b,k[b])})}),delete h[""],d.error=f,d.relations=h,d.success=i,a},function(a){return delete h[""],d.error=f,d.relations=h,d.success=i,c.Defer.reject(a)})}},G=function(a){var b=c.Sync.isEnabled(),d=c.Sync.isOnline();return a.fallback=b&&d&&!1!==a.fallback,a.offline=b&&(!d||a.offline),a.refresh=b&&d&&!1!==a.refresh,a},H={addMetadata:function(a,b){var c=(new Date).toISOString(),d=p(a),e=d?a:[a];return e=e.map(function(a){return null!=a&&(a._kmd=a._kmd||{},a._kmd.lastRefreshedAt=c,null!=b&&(a._kmd.maxAge=b)),a}),d?e:e[0]},removeMetadata:function(a){var b=p(a),c=b?a:[a];return c=c.map(function(a){return null!=a&&null!=a._kmd&&(delete a._kmd.lastRefreshedAt,delete a._kmd.maxAge),a}),b?c:c[0]},status:function(a,b){for(var c=!1,d=p(a)?a:[a],e=d.length,f=(new Date).getTime(),g=0;e>g;g+=1){var h=d[g];if(null!=h&&null!=h._kmd&&null!=h._kmd.lastRefreshedAt){var i=1e3*(b||h._kmd.maxAge),j=B(h._kmd.lastRefreshedAt).getTime(),k=j+i;if(f>k)return!1;var l=j+.9*i;f>l&&(c=!0)}}return c?{refresh:!0}:!0}};c.Persistence={create:function(a,b){if(b.relations){var d=g===a.namespace?g:a.collection;return F.save(d,a.data,b)}if(a.local=a.local||{},b=G(b),a.local.req&&b.offline)return c.Persistence.Local.create(a,b).then(null,function(d){return b.fallback&&"_group"===a.id?(b.offline=!1,c.Persistence.create(a,b)):c.Defer.reject(d)});var e=c.Persistence.Net.create(a,b);return a.local.res&&b.refresh?e.then(function(d){return a.data=d,c.Persistence.Local.create(a,b).then(function(){return d})}):e},read:function(a,b){if(a.local=a.local||{},b=G(b),a.local.req&&b.offline)return c.Persistence.Local.read(a,b).then(null,function(d){return b.fallback?(b.offline=!1,c.Persistence.read(a,b)):c.Defer.reject(d)});var d=c.Persistence.Net.read(a,b),e=b.fields||a.query&&!v(a.query._fields);return a.local.res&&b.refresh&&!e?d.then(function(d){var e;if(b.relations){var f=b.offline;b.offline=!0,b.track=!1;var h=g===a.namespace?g:a.collection;e=F.save(h,d,b).then(function(){b.offline=f,delete b.track})}else a.data=d,e=c.Persistence.Local.create(a,b);return e.then(function(){return d})},function(d){return c.Error.ENTITY_NOT_FOUND===d.name?c.Persistence.Local.destroy(a,b).then(function(){return c.Defer.reject(d)}):c.Defer.reject(d)}):d},update:function(a,b){if(b.relations){var d=g===a.namespace?g:a.collection;return F.save(d,a.data,b)}if(a.local=a.local||{},b=G(b),a.local.req&&b.offline)return c.Persistence.Local.update(a,b);var e=c.Persistence.Net.update(a,b);return a.local.res&&b.refresh?e.then(function(d){return a.data=d,c.Persistence.Local.update(a,b).then(function(){return d})}):e},destroy:function(a,b){if(a.local=a.local||{},b=G(b),a.local.req&&b.offline)return c.Persistence.Local.destroy(a,b);var d=c.Persistence.Net.destroy(a,b);return a.local.res&&b.refresh?d.then(function(d){return c.Persistence.Local.destroy(a,b).then(function(){return d},function(a){return c.Error.ENTITY_NOT_FOUND===a.name?d:c.Defer.reject(a)})}):d}};var I={batch:w("Database.batch"),clean:w("Database.clean"),count:w("Database.count"),destroy:w("Database.destroy"),destruct:w("Database.destruct"),find:w("Database.find"),findAndModify:w("Database.findAndModify"),get:w("Database.get"),group:w("Database.group"),save:w("Database.save"),update:w("Database.update"),use:x(["batch","clean","count","destroy","destruct","find","findAndModify","get","group","save","update"])};c.Persistence.Local={create:function(a,b){b=b||{};var c=g===a.namespace?g:a.collection;if("_group"===a.id)return I.group(c,a.data,b);a.data=H.addMetadata(a.data,b.maxAge);var d=p(a.data)?"batch":"save",e=I[d](c,a.data,b);return e.then(function(a){return b.offline&&!1!==b.track?K.notify(c,a,b).then(function(){return a}):a})},read:function(a,b){b=b||{};var d=g===a.namespace?g:a.collection;if("_count"===a.id)return I.count(d,a.query,b);if("_me"===a.collection){var e=c.getActiveUser();if(null!==e)return I.get(d,e._id,b).then(null,function(a){return a.name===c.Error.ENTITY_NOT_FOUND?e:c.Defer.reject(a)});var f=m(c.Error.NO_ACTIVE_USER);return c.Defer.reject(f)}var h;return h=null==a.id?I.find(d,a.query,b):I.get(d,a.id,b),h.then(function(d){var e=H.status(d,b.maxAge);return!1===e&&c.Sync.isOnline()?(b.offline=!1,c.Persistence.read(a,b)):b.relations?F.get(d,b).then(function(d){return!0===e.refresh&&c.Sync.isOnline()&&(b.offline=!1,c.Persistence.read(a,b)),d}):(!0===e.refresh&&c.Sync.isOnline()&&(b.offline=!1,c.Persistence.read(a,b)),d)})},update:function(a,b){b=b||{};var c=g===a.namespace?g:a.collection;a.data=H.addMetadata(a.data,b.maxAge);var d=I.update(c,a.data,b);return d.then(function(a){return b.offline&&!1!==b.track?K.notify(c,a,b).then(function(){return a}):a})},destroy:function(a,b){b=b||{};var c,d=g===a.namespace?g:a.collection;return c=null==a.id?I.clean(d,a.query,b):I.destroy(d,a.id,b),c.then(function(a){return b.offline&&!1!==b.track?K.notify(d,a.documents,b).then(function(){return a}):a})}};var J=null;c.Persistence.Net={create:function(a,b){return a.data=H.removeMetadata(a.data),a.method="POST",c.Persistence.Net._request(a,b)},read:function(a,b){if(a.flags=a.flags||{},b=b||{},p(b.fields)&&(a.flags.fields=b.fields.join(",")),null!=a.collection&&(!1!==b.fileTls&&(a.flags.kinveyfile_tls=!0),b.fileTtl&&(a.flags.kinveyfile_ttl=b.fileTtl)),b.relations){b.exclude=b.exclude||[];var d=Object.keys(b.relations).filter(function(a){return-1===b.exclude.indexOf(a)});0!==d.length&&(a.flags.retainReferences=!1,a.flags.resolve=d.join(","))}return a.method="GET",c.Persistence.Net._request(a,b)},update:function(a,b){return a.data=H.removeMetadata(a.data),a.method="PUT",c.Persistence.Net._request(a,b)},destroy:function(a,b){return a.method="DELETE",c.Persistence.Net._request(a,b)},_request:function(a,b){if(null==a.method)throw new c.Error("request argument must contain: method.");if(null==a.namespace)throw new c.Error("request argument must contain: namespace.");if(null==a.auth)throw new c.Error("request argument must contain: auth.");var d;if(null==c.appKey&&z.None!==a.auth)return d=m(c.Error.MISSING_APP_CREDENTIALS),c.Defer.reject(d);if(null==c.masterSecret&&b.skipBL)return d=m(c.Error.MISSING_MASTER_CREDENTIALS),c.Defer.reject(d);b.trace=b.trace||!1;var e=[a.namespace,c.appKey,a.collection,a.id];e=e.filter(function(a){return null!=a}).map(c.Persistence.Net.encode);var f=[c.API_ENDPOINT].concat(e).join("/")+"/",g=a.flags||{};if(a.query){var h=a.query.toJSON();g.query=h.filter,v(h.fields)||(g.fields=h.fields.join(",")),null!==h.limit&&(g.limit=h.limit),0!==h.skip&&(g.skip=h.skip),v(h.sort)||(g.sort=h.sort)}!1!==b.nocache&&(g._=Math.random().toString(36).substr(2));var i=[];for(var j in g)if(g.hasOwnProperty(j)){var k=u(g[j])?g[j]:JSON.stringify(g[j]);i.push(c.Persistence.Net.encode(j)+"="+c.Persistence.Net.encode(k))}0<i.length&&(f+="?"+i.join("&")),null===J&&(J=A());var l={Accept:"application/json","X-Kinvey-API-Version":c.API_VERSION,"X-Kinvey-Device-Information":J};null!=a.data&&(l["Content-Type"]="application/json; charset=utf-8"),b.contentType&&(l["X-Kinvey-Content-Type"]=b.contentType),b.skipBL&&(l["X-Kinvey-Skip-Business-Logic"]="true"),b.trace&&(l["X-Kinvey-Include-Headers-In-Response"]="X-Kinvey-Request-Id",l["X-Kinvey-ResponseWrapper"]="true");var n=a.auth().then(function(a){if(null!==a){var b=a.credentials;null!=a.username&&(b=c.Persistence.Net.base64(a.username+":"+a.password)),l.Authorization=a.scheme+" "+b}});return n.then(function(){var d=c.Persistence.Net.request(a.method,f,a.data,l,b).then(function(a){try{a=JSON.parse(a)}catch(c){}return b.trace&&s(a)?a.result:a},function(a){try{a=JSON.parse(a)}catch(d){}var e=null;if(b.trace&&(e=a.headers["X-Kinvey-Request-Id"],a=a.result),null!=a&&null!=a.error)a={name:a.error,description:a.description||"",debug:a.debug||""},b.trace&&(a.requestId=e);else{var f={abort:c.Error.REQUEST_ABORT_ERROR,error:c.Error.REQUEST_ERROR,timeout:c.Error.REQUEST_TIMEOUT_ERROR};a=m(f[a]||f.error,{debug:a})}return c.Defer.reject(a)});return d.then(null,function(a){if(c.Error.USER_LOCKED_DOWN===a.name){if(c.setActiveUser(null),"undefined"!=typeof I){var b=function(){c.Defer.reject(a)};return c.Sync.destruct().then(b,b)}}else c.Error.INVALID_CREDENTIALS===a.name&&(a.debug+=" It is possible the tokens used to execute the request are expired. In that case, please run `Kinvey.User.logout({ force: true })`, and then log back in  using`Kinvey.User.login(username, password)` to solve this issue.");return c.Defer.reject(a)})})},base64:w("Kinvey.Persistence.Net.base64"),encode:w("Kinvey.Persistence.Net.encode"),request:w("Kinvey.Persistence.Net.request"),use:x(["base64","encode","request"])};var K={enabled:!1,online:!0,system:"system.sync",count:function(a,b){if(b=b||{},null!=a)return I.get(K.system,a,b).then(function(a){return a.size},function(a){return c.Error.ENTITY_NOT_FOUND===a.name?0:c.Defer.reject(a)});var d=c.Group.sum("size").toJSON();return I.group(K.system,d,b).then(function(a){return a[0]?a[0].result:0})},execute:function(a){var b=(new c.Query).greaterThan("size",0);return I.find(K.system,b,a).then(function(b){var d=b.map(function(b){return K._collection(b._id,b.documents,a)});return c.Defer.all(d)})},notify:function(a,b,c){return I.findAndModify(K.system,a,function(c){return b=p(b)?b:[b],c=c||{_id:a,documents:{},size:0},b.forEach(function(a){c.documents.hasOwnProperty(a._id)||(c.size+=1);var b=null!=a._kmd?a._kmd.lmt:null;c.documents[a._id]=b||null}),c},c).then(function(){return null})},_collection:function(a,b,e){var f={collection:a,success:[],error:[]},h=Object.keys(b),i={namespace:g===a?g:d,collection:g===a?null:a,query:(new c.Query).contains("_id",h),auth:z.Default},j=[c.Persistence.Local.read(i,e),c.Persistence.Net.read(i,e)];return c.Defer.all(j).then(function(a){var b={local:{},net:{}};return a[0].forEach(function(a){b.local[a._id]=a}),a[1].forEach(function(a){b.net[a._id]=a}),b}).then(function(d){var g=h.map(function(c){var g={id:c,timestamp:b[c]};return K._document(a,g,d.local[c]||null,d.net[c]||null,e).then(null,function(a){return f.error.push(a.id),null})});return c.Defer.all(g)}).then(function(b){var d=b.filter(function(a){return null!=a&&null!==a.document}),f=b.filter(function(a){return null!=a&&null===a.document}),g=[K._save(a,d,e),K._destroy(a,f,e)];return c.Defer.all(g)}).then(function(b){return f.success=f.success.concat(b[0].success,b[1].success),f.error=f.error.concat(b[0].error,b[1].error),I.findAndModify(K.system,a,function(a){return f.success.forEach(function(b){a.documents.hasOwnProperty(b)&&(a.size-=1,delete a.documents[b])}),a},e)}).then(function(){return f})},_destroy:function(a,b,e){if(b=b.map(function(a){return a.id}),0===b.length)return c.Defer.resolve({success:[],error:[]});var f={namespace:g===a?g:d,collection:g===a?null:a,query:(new c.Query).contains("_id",b),auth:z.Default},h=[c.Persistence.Local.destroy(f,e),c.Persistence.Net.destroy(f,e)];return c.Defer.all(h).then(function(){return{success:b,error:[]}},function(){return{success:[],error:b}})},_document:function(a,b,d,e,f){return null===e||null!=e._kmd&&b.timestamp===e._kmd.lmt?c.Defer.resolve({id:b.id,document:d}):null!=f.conflict?f.conflict(a,d,e).then(function(a){return{id:b.id,document:a}},function(){return c.Defer.reject({id:b.id,document:[d,e]})}):c.Defer.reject({id:b.id,document:[d,e]})},_save:function(a,b,e){b=b.map(function(a){return a.document});var f=[],h=b.map(function(b){return c.Persistence.Net.update({namespace:g===a?g:d,collection:g===a?null:a,id:b._id,data:b,auth:z.Default},e).then(null,function(){return f.push(b._id),null})});return c.Defer.all(h).then(function(b){return c.Persistence.Local.create({namespace:g===a?g:d,collection:g===a?null:a,data:b,auth:z.Default},e)}).then(function(a){return{success:a.map(function(a){return a._id}),error:f}},function(){return{success:[],error:b.map(function(a){return a._id})}})}};c.Sync={count:function(a,b){b=b||{};var c=K.count(a,b);return o(c,b)},destruct:function(a){a=a||{};var b=I.destruct(a);return o(b,a)},execute:function(a){if(!c.Sync.isOnline()){var b=m(c.Error.SYNC_ERROR,{debug:"Sync is not enabled, or the application resides in offline mode."});return c.Defer.reject(b)}a=a||{};var d;return null!=a.user?(d=c.User.login(a.user).then(function(){return delete a.user,c.Sync.execute(a)}),delete a.success,o(d,a)):(d=K.execute(a),o(d,a))},init:function(a){return a=a||{},K.enabled=null!=a?a.enable:!1,K.online="undefined"!=typeof a.online?a.online:K.online,c.Defer.resolve(null)},isEnabled:function(){return K.enabled},isOnline:function(){return K.online},offline:function(){if(!c.Sync.isEnabled()){var a=m(c.Error.SYNC_ERROR,{debug:"Sync is not enabled."});return c.Defer.reject(a)}return K.online=!1,c.Defer.resolve(null)},online:function(a){if(!c.Sync.isEnabled()){var b=m(c.Error.SYNC_ERROR,{debug:"Sync is not enabled."});return c.Defer.reject(b)}a=a||{};var d=K.online;return K.online=!0,!1!==a.sync&&d!==K.online?c.Sync.execute(a):c.Defer.resolve(null)},clientAlwaysWins:function(a,b){return c.Defer.resolve(b)},serverAlwaysWins:function(a,b,d){return c.Defer.resolve(d)}},"undefined"!=typeof a.Promise&&c.Defer.use({deferred:function(){var b={};return b.promise=new a.Promise(function(a,c){b.resolve=a,b.reject=c}),b}});var L={db:null,dbName:function(){if(null==c.appKey)throw new c.Error("Kinvey.appKey must not be null.");return"Kinvey."+c.appKey},size:5e6,open:function(){return a.openDatabase(L.dbName(),1,"",L.size)},transaction:function(a,b,d,e){var f;if(!u(a)||!/^[a-zA-Z0-9\-]{1,128}/.test(a))return f=m(c.Error.INVALID_IDENTIFIER,{description:"The collection name has an invalid format.",debug:'The collection name must be a string containing only alphanumeric characters and dashes, "'+a+'" given.'}),c.Defer.reject(f);var g='"'+a+'"',h="sqlite_master"===a,i=p(b);b=i?b:[[b,d]],e=e||!1,null===L.db&&(L.db=L.open());var j=c.Defer.deferred(),k=e||!q(L.db.readTransaction);return L.db[k?"transaction":"readTransaction"](function(a){e&&!h&&a.executeSql("CREATE TABLE IF NOT EXISTS "+g+" (key BLOB PRIMARY KEY NOT NULL, value BLOB NOT NULL)");var c=b.length,d=[];b.forEach(function(b){var e=b[0].replace("#{collection}",g);a.executeSql(e,b[1],function(a,b){var e={rowCount:b.rowsAffected,result:[]};if(b.rows.length)for(var f=0;f<b.rows.length;f+=1){var g=b.rows.item(f).value,k=h?g:JSON.parse(g);e.result.push(k)}d.push(e),c-=1,0===c&&j.resolve(i?d:d.shift())})})},function(b){b=u(b)?b:b.message,f=-1!==b.indexOf("no such table")?m(c.Error.COLLECTION_NOT_FOUND,{description:"This collection not found for this app backend",debug:{collection:a}}):m(c.Error.DATABASE_ERROR,{debug:b}),j.reject(f)}),j.promise},objectID:function(a){a=a||24;for(var b="abcdef0123456789",c="",d=0,e=b.length;a>d;d+=1){var f=Math.floor(Math.random()*e);c+=b.substring(f,f+1)}return c},batch:function(a,b,d){if(0===b.length)return c.Defer.resolve(b);var e=[];b=b.map(function(a){return a._id=a._id||L.objectID(),e.push(["REPLACE INTO #{collection} (key, value) VALUES (?, ?)",[a._id,JSON.stringify(a)]]),a});var f=L.transaction(a,e,null,!0,d);return f.then(function(){return b})},clean:function(a,b,c){return null!=b&&b.sort(null).limit(null).skip(0),L.find(a,b,c).then(function(b){if(0===b.length)return{count:0,documents:[]};var d=[],e=b.map(function(a){return d.push("?"),a._id}),f="DELETE FROM #{collection} WHERE key IN("+d.join(",")+")",g=L.transaction(a,f,e,!0,c);return g.then(function(a){return a.rowCount=null!=a.rowCount?a.rowCount:b.length,{count:a.rowCount,documents:b}})})},count:function(a,b,c){return null!=b&&b.sort(null).limit(null).skip(0),L.find(a,b,c).then(function(a){return{count:a.length}})},destroy:function(a,b,d){var e=L.transaction(a,[["SELECT value FROM #{collection} WHERE key = ?",[b]],["DELETE       FROM #{collection} WHERE key = ?",[b]]],null,!0,d);return e.then(function(d){var e=d[1].rowCount,f=d[0].result;if(e=null!=e?e:d[0].result.length,0===e){var g=m(c.Error.ENTITY_NOT_FOUND,{description:"This entity not found in the collection",debug:{collection:a,id:b}});return c.Defer.reject(g)}return{count:e,documents:f}})},destruct:function(a){var b="SELECT name AS value FROM #{collection} WHERE type = ?",c=["table"],d=L.transaction("sqlite_master",b,c,!1,a);return d.then(function(b){var c=b.result;if(0===c.length)return null;var d=c.filter(function(a){return/^[a-zA-Z0-9\-]{1,128}/.test(a)}).map(function(a){return["DROP TABLE IF EXISTS '"+a+"'"]});return L.transaction("sqlite_master",d,null,!0,a)}).then(function(){return null})},find:function(b,d,e){var f="SELECT value FROM #{collection}",g=L.transaction(b,f,[],!1,e);return g.then(function(b){return b=b.result,null==d?b:(b=a.sift(d.toJSON().filter,b),d._postProcess(b))},function(a){return c.Error.COLLECTION_NOT_FOUND===a.name?[]:c.Defer.reject(a)})},findAndModify:function(a,b,d,e){var f=L.get(a,b,e).then(null,function(a){return c.Error.ENTITY_NOT_FOUND===a.name?null:c.Defer.reject(a)});return f.then(function(b){var c=d(b);return L.save(a,c,e)})},get:function(a,b,d){var e="SELECT value FROM #{collection} WHERE key = ?",f=L.transaction(a,e,[b],!1,d);return f.then(function(d){var e=d.result;if(0===e.length){var f=m(c.Error.ENTITY_NOT_FOUND,{description:"This entity not found in the collection",debug:{collection:a,id:b}});return c.Defer.reject(f)}return e[0]},function(d){return c.Error.COLLECTION_NOT_FOUND===d.name&&(d=m(c.Error.ENTITY_NOT_FOUND,{description:"This entity not found in the collection",debug:{collection:a,id:b}})),c.Defer.reject(d)})},group:function(a,b,d){var e=b.reduce.replace(/function[\s\S]*?\([\s\S]*?\)/,"");b.reduce=new Function(["doc","out"],e);var f=new c.Query({filter:b.condition});return L.find(a,f,d).then(function(a){var c={};a.forEach(function(a){var d={};for(var e in b.key)b.key.hasOwnProperty(e)&&(d[e]=a[e]);var f=JSON.stringify(d);if(null==c[f]){c[f]=d;for(var g in b.initial)b.initial.hasOwnProperty(g)&&(c[f][g]=b.initial[g])}b.reduce(a,c[f])});var d=[];for(var e in c)c.hasOwnProperty(e)&&d.push(c[e]);return d})},save:function(a,b,c){b._id=b._id||L.objectID();var d="REPLACE INTO #{collection} (key, value) VALUES (?, ?)",e=[b._id,JSON.stringify(b)],f=L.transaction(a,d,e,!0,c);return f.then(function(){return b})},update:function(a,b,c){return L.save(a,b,c)}};"undefined"!=typeof a.openDatabase&&"undefined"!=typeof a.sift&&(I.use(L),["near","regex","within"].forEach(function(b){a.sift.useOperator(b,function(){throw new c.Error(b+" query operator is not supported locally.")})}));var M={db:null,dbName:function(){if(null==c.appKey)throw new c.Error("Kinvey.appKey must not be null.");return"Kinvey."+c.appKey},impl:a.indexedDB||a.webkitIndexedDB||a.mozIndexedDB||a.oIndexedDB||a.msIndexedDB,inTransaction:!1,objectID:function(a){a=a||24;for(var b="abcdef0123456789",c="",d=0,e=b.length;a>d;d+=1){var f=Math.floor(Math.random()*e);c+=b.substring(f,f+1)}return c},pending:[],transaction:function(a,b,d,e,f){if(!u(a)||!/^[a-zA-Z0-9\-]{1,128}/.test(a))return e(m(c.Error.INVALID_IDENTIFIER,{description:"The collection name has an invalid format.",debug:'The collection name must be a string containing only alphanumeric characters and dashes, "'+a+'" given.'}));if(b=b||!1,null!==M.db){if(M.db.objectStoreNames.contains(a)){var g=b?"readwrite":"readonly",h=M.db.transaction([a],g),i=h.objectStore(a);return d(i)}if(!b)return e(m(c.Error.COLLECTION_NOT_FOUND,{description:"This collection not found for this app backend",debug:{collection:a}}))}if(!0!==f&&M.inTransaction)return M.pending.push(function(){M.transaction(a,b,d,e)});M.inTransaction=!0;var j;if(null!==M.db){var k=M.db.version+1;M.db.close(),j=M.impl.open(M.dbName(),k)}else{if(null==c.appKey)return M.inTransaction=!1,e(m(c.Error.MISSING_APP_CREDENTIALS));j=M.impl.open(M.dbName())}j.onupgradeneeded=function(){M.db=j.result,b&&M.db.createObjectStore(a,{keyPath:"_id"})},j.onsuccess=function(){M.db=j.result,M.db.onversionchange=function(){null!==M.db&&(M.db.close(),M.db=null)};var c=function(a){return function(b){var c=a(b);if(M.inTransaction=!1,0!==M.pending.length){var d=M.pending;M.pending=[],d.forEach(function(a){a()})}return c}};M.transaction(a,b,c(d),c(e),!0)},j.onerror=function(a){e(m(c.Error.DATABASE_ERROR,{debug:a}))}},batch:function(a,b){if(0===b.length)return c.Defer.resolve(b);var d=c.Defer.deferred();return M.transaction(a,!0,function(a){var e=a.transaction;b.forEach(function(b){b._id=b._id||M.objectID(),a.put(b)}),e.oncomplete=function(){d.resolve(b)},e.onerror=function(a){var b=m(c.Error.DATABASE_ERROR,{debug:a});d.reject(b)}},function(a){d.reject(a)}),d.promise},clean:function(a,b,d){return null!=b&&b.sort(null).limit(null).skip(0),M.find(a,b,d).then(function(b){if(0===b.length)return{count:0,documents:[]};var d=c.Defer.deferred();return M.transaction(a,!0,function(a){var e=a.transaction;b.forEach(function(b){a["delete"](b._id)}),e.oncomplete=function(){d.resolve({count:b.length,documents:b})},e.onerror=function(a){var b=m(c.Error.DATABASE_ERROR,{debug:a});d.reject(b)}}),d.promise})},count:function(a,b,c){return null!=b&&b.sort(null).limit(null).skip(0),M.find(a,b,c).then(function(a){return{count:a.length}})},destroy:function(a,b){var d=c.Defer.deferred();return M.transaction(a,!0,function(e){var f=e.transaction,g=e.get(b);e["delete"](b),f.oncomplete=function(){return null==g.result?d.reject(m(c.Error.ENTITY_NOT_FOUND,{description:"This entity not found in the collection",debug:{collection:a,id:b}})):void d.resolve({count:1,documents:[g.result]})},f.onerror=function(a){var b=m(c.Error.DATABASE_ERROR,{debug:a});d.reject(b)}},function(a){d.reject(a)}),d.promise},destruct:function(){if(null==c.appKey){var a=m(c.Error.MISSING_APP_CREDENTIALS);return c.Defer.reject(a)}var b=c.Defer.deferred();null!==M.db&&(M.db.close(),M.db=null);var d=M.impl.deleteDatabase(M.dbName());return d.onsuccess=function(){b.resolve(null)},d.onerror=function(a){var d=m(c.Error.DATABASE_ERROR,{debug:a});b.reject(d)},b.promise},find:function(b,d){var e=c.Defer.deferred();return M.transaction(b,!1,function(a){var b=a.openCursor(),d=[];b.onsuccess=function(){var a=b.result;null!=a?(d.push(a.value),a["continue"]()):e.resolve(d)},b.onerror=function(a){e.reject(m(c.DATABASE_ERROR,{debug:a}))}},function(a){return c.Error.COLLECTION_NOT_FOUND===a.name?e.resolve([]):e.reject(a)}),e.promise.then(function(b){return null==d?b:(b=a.sift(d.toJSON().filter,b),d._postProcess(b))})},findAndModify:function(a,b,d){var e=c.Defer.deferred();return M.transaction(a,!0,function(a){var f=null,g=a.get(b);g.onsuccess=function(){f=d(g.result||null),a.put(f)};var h=a.transaction;h.oncomplete=function(){e.resolve(f)},h.onerror=function(a){var b=m(c.Error.DATABASE_ERROR,{debug:a});e.reject(b)}},function(a){e.reject(a)}),e.promise},get:function(a,b){var d=c.Defer.deferred();return M.transaction(a,!1,function(e){var f=e.get(b);f.onsuccess=function(){return null!=f.result?d.resolve(f.result):void d.reject(m(c.Error.ENTITY_NOT_FOUND,{description:"This entity not found in the collection",debug:{collection:a,id:b}}))},f.onerror=function(a){d.reject(m(c.Error.DATABASE_ERROR,{debug:a}))}},function(e){c.Error.COLLECTION_NOT_FOUND===e.name&&(e=m(c.Error.ENTITY_NOT_FOUND,{description:"This entity not found in the collection",debug:{collection:a,id:b}})),d.reject(e)}),d.promise},group:function(a,b,d){var e=b.reduce.replace(/function[\s\S]*?\([\s\S]*?\)/,"");b.reduce=new Function(["doc","out"],e);var f=new c.Query({filter:b.condition});return M.find(a,f,d).then(function(a){var c={};a.forEach(function(a){var d={};for(var e in b.key)b.key.hasOwnProperty(e)&&(d[e]=a[e]);var f=JSON.stringify(d);if(null==c[f]){c[f]=d;for(var g in b.initial)b.initial.hasOwnProperty(g)&&(c[f][g]=b.initial[g])}b.reduce(a,c[f])});var d=[];for(var e in c)c.hasOwnProperty(e)&&d.push(c[e]);return d})},save:function(a,b){b._id=b._id||M.objectID();var d=c.Defer.deferred();return M.transaction(a,!0,function(a){var e=a.put(b);e.onsuccess=function(){d.resolve(b)},e.onerror=function(a){var b=m(c.Error.DATABASE_ERROR,{debug:a});d.reject(b)}},function(a){d.reject(a)}),d.promise},update:function(a,b,c){return M.save(a,b,c)}};"undefined"!=typeof M.impl&&"undefined"!=typeof a.sift&&(I.use(M),["near","regex","within"].forEach(function(b){a.sift.useOperator(b,function(){throw new c.Error(b+" query operator is not supported locally.")})}));var N={facebook:function(a){return N.oAuth2("facebook",a)},google:function(a){return N.oAuth2("google",a)},linkedIn:function(a){return N.oAuth1("linkedIn",a)},twitter:function(a){return N.oAuth1("twitter",a)},oAuth1:function(a,b){return N.requestToken(a,b).then(function(a){if(a.error||a.denied){var b=m(c.Error.SOCIAL_ERROR,{debug:a});return c.Defer.reject(b)}return{oauth_token:a.oauth_token,oauth_token_secret:a.oauth_token_secret,oauth_verifier:a.oauth_verifier}}).then(function(d){return c.Persistence.Net.create({namespace:g,data:d,flags:{provider:a,step:"verifyToken"},auth:z.App},b)}).then(function(c){return b._provider=a,c})},oAuth2:function(a,b){return b.state=Math.random().toString(36).substr(2),N.requestToken(a,b).then(function(a){var d;return a.state!==b.state?(d=m(c.Error.SOCIAL_ERROR,{debug:"The state parameters did not match (CSRF attack?)."}),c.Defer.reject(d)):a.error?(d=m(c.Error.SOCIAL_ERROR,{debug:a}),c.Defer.reject(d)):{access_token:a.access_token,expires_in:a.expires_in}})},requestToken:function(b,d){var e="about:blank",f=a.open(e,"KinveyOAuth2"),h=d.redirect||a.location.toString();return c.Persistence.Net.create({namespace:g,data:{redirect:h,state:d.state},flags:{provider:b,step:"requestToken"},auth:z.App},d).then(function(b){var g=c.Defer.deferred();null!=f&&(f.location=b.url);var h=0,i=100,j=a.setInterval(function(){var k;if(null==f)a.clearTimeout(j),k=m(c.Error.SOCIAL_ERROR,{debug:"The popup was blocked."}),g.reject(k);else if(f.closed)a.clearTimeout(j),k=m(c.Error.SOCIAL_ERROR,{debug:"The popup was closed unexpectedly."}),g.reject(k);else if(d.timeout&&h>d.timeout)a.clearTimeout(j),f.close(),k=m(c.Error.SOCIAL_ERROR,{debug:"The authorization request timed out."}),g.reject(k);else{var l=!1;try{l=e!==f.location.toString()}catch(n){}if(l){a.clearTimeout(j);var o=f.location,p=o.search.substring(1)+"&"+o.hash.substring(1),q=N.tokenize(p);null!=b.oauth_token_secret&&(q.oauth_token_secret=b.oauth_token_secret),g.resolve(q),f.close()}}h+=i},i);return g.promise})},tokenize:function(b){var c={};return b.split("&").forEach(function(b){var d=b.split("=",2).map(a.decodeURIComponent);d[0]&&(c[d[0]]=d[1])}),c}};if(D.use(N),"undefined"!=typeof Backbone){c.Backbone={getActiveUser:function(){var a=c.getActiveUser();return null!==a?new c.Backbone.User(a):null}},c.Error.NOT_LOGGED_IN="NotLoggedIn",k[c.Error.NOT_LOGGED_IN]={name:c.Error.NOT_LOGGED_IN,description:"This user is not logged in.",debug:""};var O={sync:function(){return c.Backbone.Sync.apply(this,arguments)}},P=function(a,b,c){c="undefined"==typeof c?!0:c;var d=b.success;b.success=function(e){if(c)if(a instanceof Backbone.Model){if(!a.set(a.parse(e,b),b))return!1}else{var f=b.reset?"reset":"set";a[f]||(f=q(a.update)?"update":"reset"),a[f](e,b)}d&&d(a,e,b),c&&a.trigger("sync",a,e,b)};var e=b.error;b.error=function(d){e&&e(a,d,b),c&&a.trigger("error",a,d,b)}},Q=function(a,b){var d=a.then(function(a){var c=b.xhr?[b.xhr.statusText,b.xhr]:[];return[a].concat(c)},function(a){var d=b.xhr?[b.xhr.statusText,b.xhr]:[null,null];return c.Defer.reject(d.concat([a]))});if("undefined"==typeof jQuery||"undefined"==typeof jQuery.Deferred)return d;var e=jQuery.Deferred();return d.then(function(a){e.resolve.apply(e,a)},function(a){e.reject.apply(e,a)}),e.promise()};c.Backbone.ModelMixin=_.extend({},O,{idAttribute:"_id",relations:[]}),c.Backbone.CollectionMixin=_.extend({},O,{query:null,clean:function(a){return a=a?_.clone(a):{},a.parse="undefined"==typeof a.parse?!0:a.parse,P(this,a),this.sync("delete",this,a)},count:function(a){a=_.clone(a)||{},a.subject=this,P(this,a,!1);var b,d=_.result(this,"url"),e=a.query||this.query;return b=g===d?c.User.count(e,a):c.DataStore.count(d,e,a),Q(b,a)},group:function(a,b){b=_.clone(b)||{},b.subject=this,P(this,b,!1);var d=b.query||this.query;null!=d&&a.query(d);var e,f=_.result(this,"url");return e=g===f?c.User.group(a,b):c.DataStore.group(f,a,b),Q(e,b)}});var R=function(a){return function(){return null===this._metadata&&(this._metadata=new c.Metadata(this.attributes)),a.apply(this._metadata,arguments)}};_.extend(c.Backbone.ModelMixin,{_metadata:null,getAcl:R(c.Metadata.prototype.getAcl),getCreatedAt:R(c.Metadata.prototype.getCreatedAt),getLastModified:R(c.Metadata.prototype.getLastModified),setAcl:function(){return R(c.Metadata.prototype.setAcl).apply(this,arguments),this}});var S={url:g};c.Backbone.UserMixin=_.extend({},c.Backbone.ModelMixin,S,{connect:function(a,b){b=b?_.clone(b):{},b.parse="undefined"==typeof b.parse?!0:b.parse,b.subject=this,P(this,b);var d=c.Social.connect(this.attributes,a,b);
return Q(d,b)},disconnect:function(a,b){b=b?_.clone(b):{},b.parse="undefined"==typeof b.parse?!0:b.parse,b.subject=this,P(this,b);var d=c.Social.disconnect(this.attributes,a,b);return Q(d,b)},getEmailVerification:R(c.Metadata.prototype.getEmailVerification),isLoggedIn:function(){var a=c.getActiveUser();if(null!==a){var b=this.get("_kmd");return null!=b&&b.authtoken===a._kmd.authtoken}return!1},login:function(a,b,d){d=_.clone(s(a)?b:d)||{},d.parse="undefined"==typeof d.parse?!0:d.parse,d.subject=this,P(this,d);var e=c.User.login(a,b,d);return Q(e,d)},logout:function(a){a=a?_.clone(a):{},a.parse="undefined"==typeof a.parse?!0:a.parse,a.subject=this,P(this,a);var b;if(this.isLoggedIn())b=c.User.logout(a);else{var d=m(c.Error.NOT_LOGGED_IN);b=c.Defer.reject(d),o(b,a)}return Q(b,a)},me:function(a){a=a?_.clone(a):{},a.parse="undefined"==typeof a.parse?!0:a.parse,a.subject=this,P(this,a);var b;if(this.isLoggedIn())b=c.User.me(a);else{var d=m(c.Error.NOT_LOGGED_IN);b=c.Defer.reject(d),o(b,a)}return Q(b,a)}}),c.Backbone.StaticUserMixin={verifyEmail:function(a,b){b=b||{};var d=c.User.verifyEmail(a,b);return Q(d,b)},forgotUsername:function(a,b){b=b||{};var d=c.User.forgotUsername(a,b);return Q(d,b)},resetPassword:function(a,b){b=b||{};var d=c.User.resetPassword(a,b);return Q(d,b)},exists:function(a,b){b=b||{};var d=c.User.exists(a,b);return Q(d,b)},restore:function(a,b){b=b||{};var d=c.User.restore(a,b);return Q(d,b)}},c.Backbone.UserCollectionMixin=_.extend(_.omit(c.Backbone.CollectionMixin,"clean"),S);var T=function(b,d){var e=[],f={},g="read"===b?"autoFetch":"autoSave",h=[],i=function(a,b,c){a.forEach(function(a){h.push({relation:a,depth:b||0,prefix:c||null})})};i(d.relations||[]);for(var j;null!=(j=h.shift());){var k=j.depth,l=j.prefix,m=j.relation;if(10!==k){var n=null;m.relatedModel&&(n=(a[m.relatedModel]||m.relatedModel).prototype);var o=m.collection||_.result(n,"url");if(null==o)throw new c.Error("collection or relatedModel must be set on the relation.");0===o.indexOf("/")&&(o=o.substr(1));var p=null!==l?l+"."+m.key:m.key;f[p]=o,!1===m[g]&&e.push(p),!1===m[g]||null==n||v(n.relations)||i(n.relations,k+1,p)}}return{exclude:e,relations:f}},U=function(a,b,d,e,f){null!=d&&s(e)&&(e._id=d);var h=null==d&&(!s(e)||p(e)),i=g===b?c.User:c.DataStore,j={create:i[g===b?"create":"save"],read:h?i.find:i.get,update:i.update,"delete":h?i.clean:i.destroy},k=[h?f.query:"read"===a||"delete"===a?d:e,f];return g!==b&&k.unshift(b),j[a].apply(i,k)};c.Backbone.Sync=function(a,b,d){d.query=d.query||b.query,d.subject=b;var e=d.silent,f=d.success;d.silent=d.silentFail||!1,d.success=function(a){d.silent=e,f&&f(a)};var g=d.attrs||b.toJSON(d),h=d.url||_.result(b,"url");if(null==h)throw new c.Error("model or options argument must contain: url.");0===h.indexOf("/")&&(h=h.substr(1));var i=h.split("/"),j=i[0],k=i[1]||g._id||null,l=b.model?b.model.prototype.relations:b.relations;if(!v(l)){var m="read"===a?"read":"write";l=T(m,this.model?this.model.prototype:this),d.exclude=l.exclude,d.relations=l.relations}var n=U(a,j,k,g,d);return Q(n,d)};var V;V="undefined"!=typeof Backbone.AssociatedModel?Backbone.AssociatedModel:Backbone.Model,c.Backbone.Model=V.extend(c.Backbone.ModelMixin),c.Backbone.Collection=Backbone.Collection.extend(_.extend({},c.Backbone.CollectionMixin,{model:c.Backbone.Model,initialize:function(a,b){var d=Backbone.Collection.prototype.initialize.apply(this,arguments);if(b=b||{},null!=b.query&&!(b.query instanceof c.Query))throw new c.Error("options.query argument must be of type: Kinvey.Query.");return this.query=b.query,d}})),c.Backbone.User=V.extend(c.Backbone.UserMixin,c.Backbone.StaticUserMixin),c.Backbone.UserCollection=Backbone.Collection.extend(_.extend({},c.Backbone.UserCollectionMixin,{model:c.Backbone.User,initialize:c.Backbone.Collection.prototype.initialize}))}var W="mobileweb"===Titanium.Platform.getName(),X=function(b,d){if(d=d||{},null==d.consumerKey)throw new c.Error("options argument must contain: consumerKey.");if(null==d.consumerSecret)throw new c.Error("options argument must contain: consumerSecret.");var e=c.Defer.deferred(),f=a.__KinveySocialAdapter[b](d);return f.addEventListener("login",function(a){if(a.success)return e.resolve({consumer_key:d.consumerKey,consumer_secret:d.consumerSecret,access_token:a.accessTokenKey,access_token_secret:a.accessTokenSecret});var b=m(c.Error.SOCIAL_ERROR,{description:a.error,debug:a});e.reject(b)}),f.authorize(),e.promise},Y={facebook:function(b){if(b=b||{},null==b.appId)throw new c.Error("options argument must contain: appId.");var d=c.Defer.deferred(),e=W?Titanium.Facebook:require("facebook");e.appid=b.appId,e.permissions=b.permissions||e.permissions||[];var f=function(b){if(e.removeEventListener("login",f),b.success){var g=e.getExpirationDate().getTime();return d.resolve({access_token:e.getAccessToken(),expires_in:a.parseInt((g-(new Date).getTime())/1e3,10)})}var h=m(c.Error.SOCIAL_ERROR,{debug:b});d.reject(h)};return e.addEventListener("login",f),e.loggedIn?e.fireEvent("login",{success:!0}):e.authorize(),d.promise},google:W?N.google:function(a){return a=a||{},a.scope=["https://www.googleapis.com/auth/userinfo.profile","https://www.googleapis.com/auth/userinfo.email"].join(" "),X("Google",a)},linkedIn:W?N.linkedIn:function(a){return X("Linkedin",a)},twitter:W?N.twitter:function(a){return X("Twitter",a)}};D.use(Y);var Z=c.Defer.resolve(null),$={_destroy:function(a){return Z=Z.then(function(){return Titanium.App.Properties.removeProperty(a),c.Defer.resolve(null)})},_get:function(a){return Z=Z.then(function(){var b=Titanium.App.Properties.getObject(a,null);return c.Defer.resolve(b)})},_save:function(a,b){return Z=Z.then(function(){return Titanium.App.Properties.setObject(a,b),c.Defer.resolve(null)})}};y.use($);var ab={dbName:function(){if(null==c.appKey)throw new c.Error("Kinvey.appKey must not be null.");return"Kinvey."+c.appKey},execute:function(a,b,d,e){if(!u(a)||!/^[a-zA-Z0-9\-]{1,128}/.test(a)){var f=m(c.Error.INVALID_IDENTIFIER,{description:"The collection name has an invalid format.",debug:'The collection name must be a string containing only alphanumeric characters and dashes, "'+a+'" given.'});return c.Defer.reject(f)}var g="'"+a+"'",h=p(b);e=e||{},b=h?b:[[b,d]];try{var i=Titanium.Database.open(ab.dbName());i.execute("BEGIN TRANSACTION"),i.execute("CREATE TABLE IF NOT EXISTS "+g+" (key BLOB PRIMARY KEY NOT NULL, value BLOB NOT NULL)");var j=b.map(function(c){var d=c[0].replace("#{collection}",g),f=i.execute(d,c[1]),h={rowCount:i.getRowsAffected(),result:null};if(null!=f){for(h.result=[];f.isValidRow();){var j=JSON.parse(f.fieldByName("value"));h.result.push(j),f.next()}f.close()}return null!=e.progress&&e.progress(a,h,b),h});return i.execute("COMMIT TRANSACTION"),i.close(),c.Defer.resolve(h?j:j.shift())}catch(k){var f=m(c.Error.DATABASE_ERROR,{debug:k.message});return c.Defer.reject(f)}},objectID:function(a){a=a||24;for(var b="abcdef0123456789",c="",d=0,e=b.length;a>d;d+=1){var f=Math.floor(Math.random()*e);c+=b.substring(f,f+1)}return c},batch:function(a,b,d){if(0===b.length)return c.Defer.resolve(b);var e=[];b=b.map(function(a){return a._id=a._id||ab.objectID(),e.push(["INSERT OR REPLACE INTO #{collection} (key, value) VALUES (?, ?)",[a._id,JSON.stringify(a)]]),a});var f=ab.execute(a,e,null,d);return f.then(function(){return b})},clean:function(a,b,c){return null!=b&&b.sort(null).limit(null).skip(0),ab.find(a,b,c).then(function(b){if(0===b.length)return{count:0,documents:[]};var d=[],e=b.map(function(a){return d.push("?"),a._id}),f="DELETE FROM #{collection} WHERE key IN("+d.join(",")+")",g=ab.execute(a,f,e,c);return g.then(function(a){return{count:a.rowCount,documents:b}})})},count:function(a,b,c){return null!=b&&b.sort(null).limit(null).skip(0),ab.find(a,b,c).then(function(a){return{count:a.length}})},destroy:function(a,b,d){var e=ab.execute(a,[["SELECT value FROM #{collection} WHERE key = ?",[b]],["DELETE       FROM #{collection} WHERE key = ?",[b]]],null,d);return e.then(function(d){var e=d[1].rowCount,f=d[0].result;if(0===e){var g=m(c.Error.ENTITY_NOT_FOUND,{description:"This entity not found in the collection",debug:{collection:a,id:b}});return c.Defer.reject(g)}return{count:e,documents:f}})},destruct:function(){var a;if(null==c.appKey)return a=m(c.Error.MISSING_APP_CREDENTIALS),c.Defer.reject(a);try{var b=Titanium.Database.open(ab.dbName());return b.remove?(b.remove(),c.Defer.resolve(null)):b.file&&b.file.deleteFile()?c.Defer.resolve(null):(a=m(c.Error.DATABASE_ERROR,{debug:"The mechanism to delete the database is not implemented for this platform."}),c.Defer.reject(a))}catch(d){return a=m(c.Error.DATABASE_ERROR,{debug:d.message}),c.Defer.reject(a)}},find:function(b,c,d){var e="SELECT value FROM #{collection}",f=ab.execute(b,e,[],d);return f.then(function(b){return b=b.result,null==c?b:(b=a.sift(c.toJSON().filter,b),c._postProcess(b))})},findAndModify:function(a,b,c,d){d=d||{};var e=null;d.progress=function(a,b,f){e=c(b.result[0]||null),f[1][1][1]=JSON.stringify(e),delete d.progress};var f=ab.execute(a,[["SELECT value FROM #{collection} WHERE key = ?",[b]],["INSERT OR REPLACE INTO #{collection} (key, value) VALUES (?, ?)",[b,null]]],null,d);return f.then(function(){return e})},get:function(a,b,d){var e="SELECT value FROM #{collection} WHERE key = ?",f=ab.execute(a,e,[b],d);return f.then(function(d){var e=d.result||[];if(0===e.length){var f=m(c.Error.ENTITY_NOT_FOUND,{description:"This entity not found in the collection",debug:{collection:a,id:b}});return c.Defer.reject(f)}return e[0]})},group:function(a,b,d){var e=b.reduce.replace(/function[\s\S]*?\([\s\S]*?\)/,"");b.reduce=new Function(["doc","out"],e);var f=new c.Query({filter:b.condition});return ab.find(a,f,d).then(function(a){var c={};a.forEach(function(a){var d={};for(var e in b.key)b.key.hasOwnProperty(e)&&(d[e]=a[e]);var f=JSON.stringify(d);if(null==c[f]){c[f]=d;for(var g in b.initial)b.initial.hasOwnProperty(g)&&(c[f][g]=b.initial[g])}b.reduce(a,c[f])});var d=[];for(var e in c)c.hasOwnProperty(e)&&d.push(c[e]);return d})},save:function(a,b,c){b._id=b._id||ab.objectID();var d="INSERT OR REPLACE INTO #{collection} (key, value) VALUES(?, ?)",e=[b._id,JSON.stringify(b)],f=ab.execute(a,d,e,c);return f.then(function(){return b})},update:function(a,b,c){return ab.save(a,b,c)}};"undefined"!=typeof Titanium.Database&&"undefined"!=typeof a.sift&&(I.use(ab),["near","regex","within"].forEach(function(b){a.sift.useOperator(b,function(){throw new c.Error(b+" query operator is not supported locally.")})}));var bb={base64:function(a){return Titanium.Utils.base64encode(a)},encode:function(a){return Titanium.Network.encodeURIComponent(a)},request:function(a,b,d,e,f){e=e||{},f=f||{};var g,h=c.Defer.deferred();s(d)&&!q(d.getLength)&&(d=JSON.stringify(d)),W?(g=new XMLHttpRequest,g.responseType=f.file?"blob":"",d instanceof Titanium.Blob&&(d=d._data),g.ontimeout=function(){h.reject("timeout")}):(g=Titanium.Network.createHTTPClient(),q(g.setTlsVersion)&&Titanium.Network.TLS_VERSION_1_2&&g.setTlsVersion(Titanium.Network.TLS_VERSION_1_2),"GET"===a&&f.file&&(e["Content-Type"]="")),g.timeout=f.timeout||0,g.onerror=g.onload=function(a){a=a||{},u(a.error)&&-1!==a.error.toLowerCase().indexOf("timed out")&&(a.type="timeout");var b="timeout"===a.type?0:this.status;if(2===parseInt(b/100,10)||304===b){var c;if(W){var d="blob"===this.responseType;c=new Titanium.Blob({data:d?this.response:this.responseText,length:d?this.response.size:this.responseText.length,mimeType:this.getResponseHeader("Content-Type")})}else c=f.file?this.responseData:this.responseText;h.resolve(c||null)}else h.reject(this.responseText||a.type||null)},g.open(a,b);for(var i in e)e.hasOwnProperty(i)&&g.setRequestHeader(i,e[i]);if(g.send(d),null!=f.subject){var j=f.subject;delete f.subject,q(j.trigger)&&j.trigger("request",j,g,f)}return h.promise}};return c.Persistence.Net.use(bb),c},c=b();"object"==typeof module&&"object"==typeof module.exports?module.exports=c:"function"==typeof define&&define.amd?define("kinvey",[],function(){return c}):a.Kinvey=c}).call(this);